# Build Stage
FROM gcc AS builder
WORKDIR /build

# Copy only the content from the src directory
COPY src/ .

RUN make

# Runtime Stage
FROM python:3.9-slim
WORKDIR /app

RUN apt-get update && \
    apt-get install -y --no-install-recommends binutils cpp && \
    rm -rf /var/lib/apt/lists/* && \
    pip install --no-cache-dir pwntools

ENV TERM=xterm

COPY --from=builder /build/vuln /app/vuln
COPY sol/exploit.py /app/exploit.py

# Expose port 31345
EXPOSE 31345

# Run the vulnerable binary
CMD ["/app/vuln"]