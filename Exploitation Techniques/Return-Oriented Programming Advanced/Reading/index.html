<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Exploitation Techniques/Return-Oriented Programming Advanced/Reading/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Return-Oriented Programming Advanced | Binary Security</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/Reading/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Return-Oriented Programming Advanced | Binary Security"><meta data-rh="true" name="description" content="In this session we are going to dive deeper into Return-Oriented Programming and setbacks that appear in modern exploitation."><meta data-rh="true" property="og:description" content="In this session we are going to dive deeper into Return-Oriented Programming and setbacks that appear in modern exploitation."><link data-rh="true" rel="canonical" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/Reading/"><link data-rh="true" rel="alternate" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/Reading/" hreflang="en"><link data-rh="true" rel="alternate" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/Reading/" hreflang="x-default"><link rel="stylesheet" href="/binary-security/assets/css/styles.a69a9d41.css">
<link rel="preload" href="/binary-security/assets/js/runtime~main.74200969.js" as="script">
<link rel="preload" href="/binary-security/assets/js/main.d9be8505.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/binary-security/"><div class="navbar__logo"><img src="/binary-security/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/binary-security/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Binary Security</b></a><a class="navbar__item navbar__link" href="/binary-security/Binary Analysis">Binary Analysis</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/binary-security/Exploitation Techniques">Exploitation Techniques</a><a class="navbar__item navbar__link" href="/binary-security/Mitigation and Defensive Strategies">Mitigation and Defensive Strategies</a><a class="navbar__item navbar__link" href="/binary-security/Extra">Extra</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/binary-security/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Binary Analysis/">Binary Analysis</a><button aria-label="Toggle the collapsible sidebar category &#x27;Binary Analysis&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/binary-security/Exploitation Techniques/">Exploitation Techniques</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exploitation Techniques&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Buffer Exploitation/">Buffer Exploitation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Buffer Exploitation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Shellcodes/">Shellcodes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Shellcodes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Shellcodes Advanced/">Shellcodes Advanced</a><button aria-label="Toggle the collapsible sidebar category &#x27;Shellcodes Advanced&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Return-Oriented Programming/">Return-Oriented Programming</a><button aria-label="Toggle the collapsible sidebar category &#x27;Return-Oriented Programming&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/">Return-Oriented Programming Advanced</a><button aria-label="Toggle the collapsible sidebar category &#x27;Return-Oriented Programming Advanced&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/Reading/">Reading</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Mitigation and Defensive Strategies/">Mitigation and Defensive Strategies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Mitigation and Defensive Strategies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Extra/">Extra</a><button aria-label="Toggle the collapsible sidebar category &#x27;Extra&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/binary-security/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/binary-security/Exploitation Techniques/"><span itemprop="name">Exploitation Techniques</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/"><span itemprop="name">Return-Oriented Programming Advanced</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Reading</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Return-Oriented Programming Advanced</h1><p>In this session we are going to dive deeper into Return-Oriented Programming and setbacks that appear in modern exploitation.
Topics covered:</p><ul><li>ROP for syscalls and 64 bits</li><li>Dealing with ASLR in ROP</li><li>Dealing with low space in the overflown buffer</li><li>Combining ROP and shellcodes</li></ul><p>As the basis of the lab we will use a program based on a classical CTF challenge called <code>ropasaurusrex</code> and gradually make exploitation harder.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="calling-conventions-in-the-rop-context">Calling Conventions in the ROP Context<a class="hash-link" href="#calling-conventions-in-the-rop-context" title="Direct link to heading">​</a></h2><p>As you know, the calling convention for 32 bits uses the stack.
This means that setting up parameters is as easy as just writing them in the payload.</p><p>We can see how a function call is generated in this <a href="https://gcc.godbolt.org/z/MPG5MhEnE" target="_blank" rel="noopener noreferrer">Compiler Explorer example</a>.</p><p> Syscalls are special, the arguments are passed using the registers and <code>int 0x80</code> or the equivalent <code>call DWORD PTR gs:0x10</code> is used such that more work is needed: <code>pop ?; ret</code> gadgets are needed to load the registers with the desired values.</p><p>In the assembly below you see a disassembly of the calling of a system call <code>read(0, 0x8048000, 0x100)</code>, with the system call in the <code>eax</code> register and the system call arguments in the other registers:</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mov eax, 0x3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov ebx, 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov ecx, 0x08048000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov edx, 0x100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int 0x80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The calling convention for 64 bit processors (<code>x86_64</code>) is different and mainly uses registers instead of the stack, see this <a href="https://gcc.godbolt.org/z/1Ys6M3Pdc" target="_blank" rel="noopener noreferrer">Compiler Explorer example</a>.</p><p>Syscalls on 64 bits are conceptually the same as on 32 bits, but it uses different registers, different syscall codes and the <code>syscall</code> mnemonic is used for making a system call:</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mov rax, 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov rdi, 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov rsi, 0x08048000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov rdx, 0x100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syscall</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rop-gadgets-on-x86_64">ROP gadgets on x86_64<a class="hash-link" href="#rop-gadgets-on-x86_64" title="Direct link to heading">​</a></h2><p>On <code>x86_64</code> the ROP payloads will have to be built differently than on <code>x86</code> because of the different calling convention.
Having the function arguments stored in registers means that you don&#x27;t need to do stack cleanup anymore, but you will need gadgets with <strong>specific registers</strong> to pop the arguments into.</p><p>For example to do the <code>read(0, buf, size)</code> libc call to do this call your payload will need to look like:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pop rdi; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop rsi, ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">buf_addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop rdx; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call read@plt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="libc-leaks">Libc leaks<a class="hash-link" href="#libc-leaks" title="Direct link to heading">​</a></h2><p>You might have already encountered in other tasks the need to leak values or addresses.
Most of the time, if you want to get a shell, you won&#x27;t have a convenient <code>system@plt</code> symbol present in your binary, and <code>ASLR</code> will most often be activated;
so you will have to compute it relative to another libc symbol at runtime.</p><p>For this we will need to know what libc library the program is loading.
For a local executable we can just run <code>ldd</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ldd rop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    linux-vdso.so.1 (0x00007ffd0834b000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007fec18eb6000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007fec190aa000)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For remote tasks you can might get an attached <code>libc.so</code>, or you can use the <a href="https://libc.blukat.me/" target="_blank" rel="noopener noreferrer">Libc database</a> to find the correct libc based on some leaked offsets.</p><p>How to compute and use the <code>system</code> function address using pwntools:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/usr/lib/libc.so.6&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># from `ldd rop`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;rop&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># read the leaked address of the write@got function from the program</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write_leak </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># compute the starting address of the libc library</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># setting libc.address to this value will offset all future symbol accesses</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> write_leak </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">symbols</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;write&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># use the address of system in the payload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">symbols</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;system&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="challenges">Challenges<a class="hash-link" href="#challenges" title="Direct link to heading">​</a></h2><p><strong>Note</strong>: All tasks from this session are 64 bit binaries, so take that into consideration when you build the ROP chains.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="01-challenge---using-rop-to-leak-and-call-system">01. Challenge - Using ROP to Leak and Call system<a class="hash-link" href="#01-challenge---using-rop-to-leak-and-call-system" title="Direct link to heading">​</a></h3><p>Use the <code>01-leak-call-system/src</code> executable file in order to spawn a shell.</p><p>You can now call the functions in the binary but <code>system</code> or any other appropriate function is missing and ASLR is enabled.
How do you get past this?
You need an information leak!
To leak information we want to print it to standard output and process it.
We use calls to <code>printf</code>, <code>puts</code> or <code>write</code> for this.
In our case we can use the <code>write</code> function call.</p><p>If you have a string representation of a number you can unpack it using the <code>unpack</code>/<code>u64</code> function in pwntools.
It is the reverse of the <code>pack</code>/<code>p64</code> function.</p><p>First, trigger the information leak by calling the <code>write</code> function and leaking an address from libc.</p><p>You can use the GOT table storing libc addresses.</p><p>You need to read the output from the above <code>write</code> call.
Use <code>p.recv(8)</code> in the Python script to read the 8 bytes output of the <code>write</code> call in the <code>ROP</code> chain.</p><p>Remember that you need gadgets to pop values into <code>rdi</code>, <code>rsi</code>, <code>rdx</code> for the <code>write</code> call.</p><p>Find the address of the <code>system</code> call.</p><p>Remember the libc leaks section above</p><p>Call `system().</p><p>You can&#x27;t write the <code>system</code> address in the ROP chain as it is different each time and the ROP chain is statically defined.
You can use the GOT table again.
Write an entry in the GOT table with the newly found address and call the function for that entry.
It will evolve into a call to <code>system</code>.</p><p>To write an entry in the GOT table use the <code>read</code> call in the ROP chain.
You will feed to <code>read</code> the computed address below.</p><p>For the actual parameter use the <code>&quot;sh&quot;</code> string already present in the vulnerable binary.
Use <code>searchmem</code> in GDB to find the <code>&quot;sh&quot;</code> string in the executable.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="02-challenge---handling-low-stack-space">02. Challenge - Handling Low Stack Space<a class="hash-link" href="#02-challenge---handling-low-stack-space" title="Direct link to heading">​</a></h3><p>The previous binary had the luxury of plenty of stack space to be overflown.
It is often the case that we don&#x27;t have enough space for a long ROP chain.
Let&#x27;s handle that.</p><p>For the current task, switch to the <code>02-low-stack-space/src</code> sub-folder.
The extra constraint here is that huge ROP chains are no longer an option.</p><p>Find out how much space you have in the overflow and assess the situation.</p><p>Use <code>gdb</code> and the cyclic pattern to get the information required.</p><p>Now follow the steps below.</p><p>First trigger the info leak as before.</p><p>Use <code>write</code> and leak the address of a GOT value.
Use this to compute the address of the <code>system</code> call.</p><p>You can only construct a partial ROP chain.
A longer one won&#x27;t fit.
So after calling <code>write</code>, call <code>main</code> again.</p><p>Note that using <code>sendline</code> means sending out a newline character (<code>&#x27;\n&#x27;</code>) at the end of the message.
If you want to strictly send out a message without a newline, use <code>send</code>.</p><p>Find the address of <code>main</code> by looking at the argument for the <code>__libc_start_main</code> function.
Check the disassembling of the program and see what is the parameter passed to the <code>__libc_start_main call</code>.</p><p>After calling <code>main</code> again you will get back to the initial situation where you can exploit the buffer overflow.</p><p>Insert <code>&quot;sh&quot;</code> string.</p><p>This time you don&#x27;t have the <code>&quot;sh&quot;</code> string in the binary, but you can find it in <strong>the libc binary itself</strong> so you can compute it the same way you compute the <code>system</code> address.
In pwntools:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Call <code>system</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="03-challenge---stack-pivoting">03. Challenge - Stack Pivoting<a class="hash-link" href="#03-challenge---stack-pivoting" title="Direct link to heading">​</a></h3><p>Let&#x27;s assume that <code>main</code> function had additional constraints that made it impossible to repeat the overflow.
How can we still solve it?
The method is called stack pivoting.
In short, this means making the stack pointer refer another (writable) memory area that has enough space, a memory area that we will populate with the actual ROP chain.</p><p>Read more about stack pivoting <a href="http://neilscomputerblog.blogspot.ro/2012/06/stack-pivoting.html" target="_blank" rel="noopener noreferrer">here</a>.</p><p>Tour goal is to fill the actual ROP chain to a large enough memory area.
We need a two stage exploit:</p><ul><li>In the first stage, prepare the memory area where to fill the second stage ROP chain;
then fill the memory area with the second stage ROP chain.</li><li>In the second stage, create the actual ROP chain and feed it to the program and profit.</li></ul><p>Follow the steps below.</p><p>Use <code>pmap</code> or <code>vmmap</code> in <code>pwndbg</code> to discover the writable data section of the process.
Select an address in that section (<strong>don&#x27;t</strong> use the start address).
This is where you fill the 2nd stage data (the actual ROP chain).</p><p>Who not use the start address?
Because <code>pop</code> instructions (which decrease the <code>rsp</code>) will go outside the memory region.</p><p>Create a first stage payload that calls <code>read</code> to store the 2nd stage data to the newly found memory area.
After that pivot the stack pointer to the memory area address.</p><p>At a given address in the executable you have a call to <code>read</code> followed by a <code>leave; ret</code> gadget.
This sequence of instructions allows you to read data and then pivot the stack.</p><p>The leave instruction fills the stack pointer (<code>rsp</code>) with the address of the frame pointer (<code>rbp</code>).
It&#x27;s equivalent to:</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mov rsp, rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop rbp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Write the actual ROP chain as a second stage payload like when we didn&#x27;t have space constraints.
The 2nd stage will be stored to the memory area and the stack pointer will point to that.</p><p><strong>Important!</strong>
Be careful when and where the stack pivoting takes place.
After the <code>mov rsp, rbp</code> part of the <code>leave</code> instruction happens your stack will be pivoted, so the following <code>pop rbp</code> will happen <strong>on the new stack</strong>.
Take this offset into account when building the payload.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="04-challenge---mprotect">04. Challenge - mprotect<a class="hash-link" href="#04-challenge---mprotect" title="Direct link to heading">​</a></h3><p>Combine everything you&#x27;ve learned until now and develop a complex payload to call <code>mprotect</code> to change the permissions on a memory region to read+write+execute and then insert a shellcode to call <code>system(&quot;/bin/sh&quot;)</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further Reading<a class="hash-link" href="#further-reading" title="Direct link to heading">​</a></h2><ul><li><a href="https://syscalls.kernelgrok.com/" target="_blank" rel="noopener noreferrer">https://syscalls.kernelgrok.com/</a></li><li><a href="http://articles.manugarg.com/systemcallinlinux2_6.html" target="_blank" rel="noopener noreferrer">http://articles.manugarg.com/systemcallinlinux2_6.html</a></li><li><a href="https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries#the-procedure-linkage-table-plt" target="_blank" rel="noopener noreferrer">https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries#the-procedure-linkage-table-plt</a></li><li><a href="https://github.com/Gallopsled/pwntools-tutorial/tree/master/walkthrough" target="_blank" rel="noopener noreferrer">https://github.com/Gallopsled/pwntools-tutorial/tree/master/walkthrough</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Return-Oriented Programming Advanced</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/binary-security/Mitigation and Defensive Strategies/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Mitigation and Defensive Strategies</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#calling-conventions-in-the-rop-context" class="table-of-contents__link toc-highlight">Calling Conventions in the ROP Context</a></li><li><a href="#rop-gadgets-on-x86_64" class="table-of-contents__link toc-highlight">ROP gadgets on x86_64</a></li><li><a href="#libc-leaks" class="table-of-contents__link toc-highlight">Libc leaks</a></li><li><a href="#challenges" class="table-of-contents__link toc-highlight">Challenges</a><ul><li><a href="#01-challenge---using-rop-to-leak-and-call-system" class="table-of-contents__link toc-highlight">01. Challenge - Using ROP to Leak and Call system</a></li><li><a href="#02-challenge---handling-low-stack-space" class="table-of-contents__link toc-highlight">02. Challenge - Handling Low Stack Space</a></li><li><a href="#03-challenge---stack-pivoting" class="table-of-contents__link toc-highlight">03. Challenge - Stack Pivoting</a></li><li><a href="#04-challenge---mprotect" class="table-of-contents__link toc-highlight">04. Challenge - mprotect</a></li></ul></li><li><a href="#further-reading" class="table-of-contents__link toc-highlight">Further Reading</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://security-summer-school.github.io/binary/" target="_blank" rel="noopener noreferrer" class="footer__link-item">site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/SSSUPB/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 SSS Team</div></div></div></footer></div>
<script src="/binary-security/assets/js/runtime~main.74200969.js"></script>
<script src="/binary-security/assets/js/main.d9be8505.js"></script>
</body>
</html>