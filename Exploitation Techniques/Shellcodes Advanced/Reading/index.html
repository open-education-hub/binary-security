<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Exploitation Techniques/Shellcodes Advanced/Reading/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Shellcodes (Advanced) | Binary Security</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Shellcodes Advanced/Reading/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Shellcodes (Advanced) | Binary Security"><meta data-rh="true" name="description" content="In the &quot;Shellcodes&quot; session, we learned about shellcodes, a form of code injection which allowed us to hijack the control flow of a process and make it do our bidding."><meta data-rh="true" property="og:description" content="In the &quot;Shellcodes&quot; session, we learned about shellcodes, a form of code injection which allowed us to hijack the control flow of a process and make it do our bidding."><link data-rh="true" rel="canonical" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Shellcodes Advanced/Reading/"><link data-rh="true" rel="alternate" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Shellcodes Advanced/Reading/" hreflang="en"><link data-rh="true" rel="alternate" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Shellcodes Advanced/Reading/" hreflang="x-default"><link rel="stylesheet" href="/binary-security/assets/css/styles.a69a9d41.css">
<link rel="preload" href="/binary-security/assets/js/runtime~main.74200969.js" as="script">
<link rel="preload" href="/binary-security/assets/js/main.d9be8505.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/binary-security/"><div class="navbar__logo"><img src="/binary-security/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/binary-security/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Binary Security</b></a><a class="navbar__item navbar__link" href="/binary-security/Binary Analysis">Binary Analysis</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/binary-security/Exploitation Techniques">Exploitation Techniques</a><a class="navbar__item navbar__link" href="/binary-security/Mitigation and Defensive Strategies">Mitigation and Defensive Strategies</a><a class="navbar__item navbar__link" href="/binary-security/Extra">Extra</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/binary-security/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Binary Analysis/">Binary Analysis</a><button aria-label="Toggle the collapsible sidebar category &#x27;Binary Analysis&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/binary-security/Exploitation Techniques/">Exploitation Techniques</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exploitation Techniques&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Buffer Exploitation/">Buffer Exploitation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Buffer Exploitation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Shellcodes/">Shellcodes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Shellcodes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/binary-security/Exploitation Techniques/Shellcodes Advanced/">Shellcodes Advanced</a><button aria-label="Toggle the collapsible sidebar category &#x27;Shellcodes Advanced&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/binary-security/Exploitation Techniques/Shellcodes Advanced/Reading/">Reading</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Return-Oriented Programming/">Return-Oriented Programming</a><button aria-label="Toggle the collapsible sidebar category &#x27;Return-Oriented Programming&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/">Return-Oriented Programming Advanced</a><button aria-label="Toggle the collapsible sidebar category &#x27;Return-Oriented Programming Advanced&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Mitigation and Defensive Strategies/">Mitigation and Defensive Strategies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Mitigation and Defensive Strategies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Extra/">Extra</a><button aria-label="Toggle the collapsible sidebar category &#x27;Extra&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/binary-security/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/binary-security/Exploitation Techniques/"><span itemprop="name">Exploitation Techniques</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/binary-security/Exploitation Techniques/Shellcodes Advanced/"><span itemprop="name">Shellcodes Advanced</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Reading</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Shellcodes (Advanced)</h1><p>In <a href="/binary-security/Exploitation Techniques/Shellcodes/Reading">the &quot;Shellcodes&quot; session</a>, we learned about <strong>shellcodes</strong>, a form of <strong>code injection</strong> which allowed us to hijack the control flow of a process and make it do our bidding.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>The three steps for a successful shellcode attack are:</p><ul><li><strong>develop</strong>: obtain the machine code for the desired functionality</li><li><strong>inject</strong>: place the shellcode into the process&#x27; address space</li><li><strong>trigger</strong>: divert control flow to the beginning of our shellcode</li></ul><p>The first step seems pretty straightforward, but there are a lot of things that could go wrong with the last two.
For example, we cannot inject a shellcode in a process that doesn&#x27;t read input or reads very little (though remember that if we can launch the target program we can place the shellcode inside its environment or command-line arguments);
we cannot trigger our shellcode if we cannot overwrite some code-pointer (e.g.
a saved return) or if we do not know the precise address at which it ends up in the process&#x27; memory and we cannot use such an attack if there isn&#x27;t some memory region where we have both write and execute permissions.</p><p>Some of these hurdles can occur naturally, while others are intentionally created as preventive measures (e.g.
on modern platforms, any memory area can be either writable or executable, but not both, a concept known as <a href="https://en.wikipedia.org/wiki/W%5EX" target="_blank" rel="noopener noreferrer">W^X</a>).
Anyway, it is useful to think about these problems and how to work around them, then put that knowledge into practice.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tutorials">Tutorials<a class="hash-link" href="#tutorials" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="01-tutorial-preventing-stack-operations-from-overwriting-the-shellcode">01. Tutorial: preventing stack operations from overwriting the shellcode<a class="hash-link" href="#01-tutorial-preventing-stack-operations-from-overwriting-the-shellcode" title="Direct link to heading">​</a></h3><p>When performing a shellcode attack we often needed to write some stuff in memory so that it has a valid address.
For example, to perform an <code>execve(&quot;/bin/sh&quot;, [&quot;/bin/sh&quot;, NULL], NULL)</code> syscall, we need to place the string <code>&quot;/bin/sh&quot;</code> in  memory and fill the <code>rdi</code> register (first argument of a syscall) with that address.
In theory we could write it in any writable area but, as you might have noticed in the previous session, it&#x27;s usually simpler to just use the stack.</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, `/bin/sh`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    push rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>results in fewer machine-code bytes than:</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, `/bin/sh`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rbx, 0x00404000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov qword [rbx], rax</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>plus, <code>push</code>-ing has the side effect of placing our address in the <code>rsp</code> register which we could later <code>mov</code> somewhere else, avoiding the need of explicitly referring to some address (which might be difficult to predict, or even random, in the case of ASLR).</p><p>In cases where our shellcode is also injected on the stack this leads to the complicated situation in which the stack serves as both a code and data region.
If we aren&#x27;t careful, our data pushes might end up overwriting the injected code and ruining our attack.</p><p>Run <code>make</code> then use the <code>exploit.py</code> script (don&#x27;t bother with how it works, for now);
it will create a shellcode, pad it and feed it to the program, then open a new terminal window with a <code>gdb</code> instance break at the end of the <code>main</code> function.
You can then explore what happens step by step and you will notice that, as the shellcode pushes the data it needs onto the stack it eventually comes to overwrite itself, resulting in some garbage.</p><p>The problem is that, after executing <code>ret</code> at the end of <code>main</code> and getting hijacked to jump to the beginning of our shellcode, <code>rip</code> ends up at <code>0x7ffca44f2280</code>, while <code>rsp</code> ends up at <code>0x7ffca44f22c0</code> (addresses on your machine will probably differ).
The instruction pointer is only 64 bytes <strong>below</strong> the stack pointer.</p><ul><li>as instructions get executed, the instruction pointer is incremented</li><li>as values are pushed onto the stack, the stack pointer is decremented</li></ul><p>Thus the difference will shrink more and more with each instruction executed.
The total length of the shellcode is 48 bytes so that means that after pushing 16 bytes onto the stack (64 - 48) any <code>push</code> will overwrite the end of our shellcode!</p><p>One obvious solution is to try and modify our shellcode to make it shorter, or to make it push less data onto the stack;
this might work in some situations, but it&#x27;s not a general fix.</p><p>Remember that after the vulnerable function returns, we control the execution of the program;
so we can control what happens to the stack!
Then we&#x27;ll simply move the top of the stack to give us some space by adding this as the first instruction to our shellcode:</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  sub rsp, 64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, right after jumping to our shellcode, <code>rip</code> and <code>rsp</code> will be the same, but they&#x27;ll go on in opposite directions and everything will be well.
Uncomment line 64 in <code>exploit.py</code>, run it again and see what happens.</p><p>If we&#x27;re at the very low-edge of the stack and can&#x27;t access memory below, we can use <code>add</code> to move the stack pointer way up, so that even if the pushed data comes towards our injected code, it will not reach it;
after all, our shellcode is short and we&#x27;re not pushing much.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="02-tutorial-nop-sleds">02. Tutorial: NOP sleds<a class="hash-link" href="#02-tutorial-nop-sleds" title="Direct link to heading">​</a></h3><p>In the previous session, you probably had some difficulties with the 9th task in <a href="/binary-security/Exploitation Techniques/Shellcodes/Reading">the &quot;Shellcodes&quot; section</a>, which asked you to perform a shellcode-on-stack attack without having a leak of the overflown buffer&#x27;s address.
You can determine it using <code>gdb</code> but, as you&#x27;ve seen, things differ between <code>gdb</code> and non-<code>gdb</code> environments;
the problem is even worse if the target binary is running on a remote machine.</p><p>The crux of the issue is the fact that we have to precisely guess <strong>one</strong> exact address where our shellcode begins.
For example, our shellcode might end up looking like this in memory:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffce28:  rex.WX adc QWORD PTR [rax+0x0],rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffce2c:  add    BYTE PTR [rax],al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffce2e:  add    BYTE PTR [rax],al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=&gt; 0x7fffffffce30:  push   0x68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffce32:  movabs rax,0x732f2f2f6e69622f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffce3c:  push   rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffce3d:  mov    rdi,rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffce40:  push   0x1016972</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The first instruction of our shellcode is the <code>push 0x68</code> at address <code>0x7fffffffce30</code>:</p><ul><li>if we jump before it, we&#x27;ll execute some garbage interpreted as code;
in the above example, missing it by two bytes would execute <code>add    BYTE PTR [rax],al</code> which might SEGFAULT if <code>rax</code> doesn&#x27;t happen to hold a valid writable address</li><li>if we jump after it, we&#x27;ll have a malformed <code>&quot;/bin/sh&quot;</code> string on the stack, so the later <code>execve</code> call will not work.</li></ul><p>Fortunately, we don&#x27;t have to consider the entire address space, so our chances are better than 1 in $2^64$.</p><ul><li>the stack is usually placed at a fixed address (e.g. <code>0x7fffffffdd000</code>), so we have a known-prefix several octets wide</li><li>due to alignment concerns, the compiler emits code that places buffers and other local data at nice, rounded addresses (ending in <code>0</code>, or <code>c0</code>, <code>00</code> etc.), so we have a known-suffix several bits wide</li></ul><p>On your local machine, using <code>gdb</code> to look at the buffer&#x27;s address will then allow you to use just a bit of brute-force search to determine the address outside of <code>gdb</code>.</p><p>But what if we could increase our chances to jump to the beginning of our shellcode?
So that we don&#x27;t have to guess <strong>one</strong> exact address, but just hit some address range?
This is where &quot;NOP sleds&quot; come in.</p><p>A &quot;NOP sled&quot; is simply a string of <code>NOP</code> instructions added as a prefix to a shellcode.
The salient features of a <code>NOP</code> instruction that make it useful for us are:</p><ul><li>it does nothing</li><li>it&#x27;s one byte long</li></ul><p>Thus if we chain a bunch of these together and prepend them to our shellcode, we can jump inside the middle of the &quot;NOP sled&quot; at any position and it will be alright: each subsequent <code>NOP</code> instruction will be executed, doing nothing, then our shellcode will be reached.</p><p>Our shellcode will end up looking like this in the process memory:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffd427:  mov BYTE PTR [rax], al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffd429:  nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffd42a:  nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffd42b:  nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffd42c:  nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffd42d:  nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffd42e:  nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffd42f:  nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=&gt; 0x7fffffffd430:  push   0x68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffd432:  movabs rax,0x732f2f2f6e69622f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7fffffffd43c:  push   rax</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Again, our first &quot;useful&quot; instruction is the <code>push 0x68</code> at <code>0x7fffffffd430</code>.
Jumping after it and skipping its execution is still problematic, but notice that we can now jump <strong>before</strong> it, missing it by several bytes with no issue.
If we jump to <code>0x7fffffffd42c</code> for example, we&#x27;ll reach a <code>nop</code>, then execution will pass on to the next <code>nop</code> and so on;
after executing 4 <code>NOPs</code>, our shellcode will be reached and everything will be as if we had jumped directly to <code>0x7fffffffd430</code> in the first place.
There is now a continuous range of 8 addresses where it&#x27;s OK to jump to.</p><p>But 8 is such a small number;
the longer the NOP sled, the better our chances.
The only limit is how much data we can feed into the program when we inject our shellcode.</p><ul><li>Run <code>make</code>, then inspect the <code>vuln</code> binary in <code>gdb</code> and determine the location of the vulnerable buffer.</li><li>Modify line 14 of the <code>exploit.py</code> script with the address you&#x27;ve found, then run the script.
Most likely, it will not work: the address outside of <code>gdb</code> is different.</li><li>Uncomment line 17 of the script, then run it again.</li><li>You should now have a shell!</li></ul><p>If this doesn&#x27;t work, play a bit with the address left on line 14;
increment it by 256, then decrement it by 256.
You&#x27;re aiming to get <strong>below</strong> the actual address at some offset smaller than the NOP sled length which, in this example, is 1536.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="03-tutorial-null-free-shellcodes">03. Tutorial: null-free shellcodes<a class="hash-link" href="#03-tutorial-null-free-shellcodes" title="Direct link to heading">​</a></h3><p>Up until now, all the vulnerable programs attacked used <code>read</code> as a method of getting the input.
This allows us to feed them any string of arbitrary bytes.
In practice, however, there are many cases in which the input is treated as a 0-terminated string and processed by functions like <code>strcpy</code>.</p><p>This means that our shellcode cannot contain a 0 byte because, as far as functions like <code>strcpy</code> are concerned, that signals the end of the input.
However, shellcodes are likely to contain 0 bytes.
For example, remember that we need to set <code>rax</code> to a value indicating the syscall we want;
if we wish to <code>execve</code> a new shell, we&#x27;ll have to place the value <code>59</code> in <code>rax</code>:</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  mov rax, 0x3b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Due to the nature of x86 instructions and the size of the <code>rax</code> register, that <code>0x3b</code> might be considered an 8-byte wide constant, yielding the following machine code: <code>48 b8 59 00 00 00 00 00 00 00</code>.</p><p>As you can see, there are quite a lot of zeroes.
We could get rid of them if we considered <code>0x3b</code> to be a 1-byte wide constant;
unfortunately there&#x27;s no instruction to place into <code>rax</code> an immediate 1-byte value.
However, there is an instruction to place an immediate 1-byte value in <code>al</code>, the lowest octet of <code>rax</code>.
But we need the other seven octets to be 0...
Fortunately, we can do a trick by xor-ing the register with itself!
This will make every bit 0, plus the <code>xor</code> instruction itself doesn&#x27;t contain 0 bytes.
So we can replace the code above with:</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  xor rax, rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mov al, 0x3b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Which assembles to <code>48 31 c0 b0 3b</code>.
Not only are there no 0 bytes, we&#x27;ve also reduced the size of the code!</p><p>Takeaways:</p><ul><li>xor-ing a register with itself is a good way of obtaining some zeroes in memory without using zeroes in machine code</li><li>working with the lower parts of registers avoids immediate values with leading-zeroes</li></ul><p>We can apply these insights in other situations to avoid zeroes in our code.
For example, instead of</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, `/bin/sh\0`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    push rax</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can write:</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    xor rax, rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    push rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, `//bin/sh`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    push rax</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that extra-slashes in a path don&#x27;t make any difference.</p><p>The <code>vuln.c</code> program reads data properly into a buffer, then uses <code>strcpy</code> to move data into a smaller buffer, resulting in an overflow.
Run <code>make</code>, then the <code>exploit.py</code> script;
just like before, it will start a new terminal window with a <code>gdb</code> instance in which you can explore what happens.
The attack will fail because the injected shellcode contains 0 bytes so <code>strcpy</code> will only stop copying well before the end of the shellcode.</p><p>Comment line 55 and uncomment line 56, replacing the shellcode with a null-free version.
Run <code>exploit.py</code> again.
It should work!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="04-tutorial-shellcodes-in-pwntools">04. Tutorial: shellcodes in pwntools<a class="hash-link" href="#04-tutorial-shellcodes-in-pwntools" title="Direct link to heading">​</a></h3><p>Once again, <code>pwntools</code> can come to our aid and help us with shellcode attacks.
The most useful feature for this is the <a href="https://docs.pwntools.com/en/stable/shellcraft.html" target="_blank" rel="noopener noreferrer"><code>shellcraft</code> module</a> which offers prebuilt shellcodes for various architectures.</p><p>For example, to obtain a shellcode which performs <code>execve(&quot;/bin/sh&quot;, {&quot;/bin/sh&quot;, NULL}, NULL)</code> on an <code>x86_64</code> platform we can call:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">shellcraft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">amd64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">linux</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that this will give you back text representing assembly code and <strong>not</strong> machine code bytes.
You can then use the <code>asm</code> function to assemble it:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">asm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shellcraft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">amd64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">linux</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arch</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;amd64&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> os</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;linux&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Remember the friendly features of pwntools!
Instead of always specifying the OS and the architecture, we can set them in the global context, like this:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;amd64&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">os</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;linux&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Or - even simpler - we can indicate a particular binary and let pwntools deduce the OS and architecture: <code>context.binary = &quot;./vuln&quot;</code>.
We can then invoke a much cleaner <code>asm(shellcraft.sh())</code>.</p><p>Besides the magic snippet to invoke a shell, there are other built-in code fragments, such as to cause a crash, an infinite loop, <code>cat</code> a file or call some other syscall.
Play around with <code>shellcraft</code>, inspecting the output.
You&#x27;ll notice that all these shellcodes are free of zero bytes and newlines!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="05-tutorial-alphanumeric-shellcode">05. Tutorial: alphanumeric shellcode<a class="hash-link" href="#05-tutorial-alphanumeric-shellcode" title="Direct link to heading">​</a></h3><p>It is commonly the case that user input is filtered to make sure it matches certain conditions.
Most user input expected from a keyboard should not contain non-printable characters;
a &quot;name&quot; should contain only letters, a PIN should contain only digits, etc.</p><p>The program might check its input against some conditions and, if rejected, bail in such a way so as to not trigger our injected code.
This places the burden on us to develop shellcode that doesn&#x27;t contain certain bytes.
We&#x27;ve seen how we can avoid newlines and zero bytes to work around some input-reading functions.
This concept can be pushed even further, heavily restricting our character set: on 32-bit platforms, we can write <strong>alphanumeric shellcodes</strong>!</p><p>But can we really?
It&#x27;s plausible that there are some clever tricks on the level of replacing <code>mov eax, 0x3b</code> with <code>xor eax, eax; mov al, 0x3b</code> that could make use of only alphanumeric characters, but all our shellcodes so far need to perform a syscall.
Looking at the encoding of the <code>int 0x80</code> instruction seems pretty grim: <code>\xcd\x80</code>.
Those are not even printable characters.
So how can we perform a syscall?</p><p>Here it&#x27;s important to step back and carefully consider our assumptions:</p><ul><li>There is some memory region to which we have both write and execute access (otherwise we wouldn&#x27;t attempt a code injection attack)</li><li>After our input is read, there is some check on it to make sure it doesn&#x27;t contain certain characters.</li></ul><p>Aha!
We cannot <strong>inject</strong> some bytes, but nothing&#x27;s stopping us from injecting something that <strong>generates</strong> those bytes!
Generating is just an alternative way of writing, so instead of <strong>injecting</strong> our shellcode, we&#x27;ll inject some code which <strong>generates</strong> the shellcode, then executes it!</p><p>This is, in fact, as complicated as it sounds, so we won&#x27;t do it ourselves.
We&#x27;ll just observe how such a shellcode, produced by a specialized tool (<code>msfvenom</code>) works.
So invoke the following command, which should give you a python-syntax buffer containing an alphanumeric shellcode that executes &quot;/bin/sh&quot;:</p><p><code>msfvenom -a x86 --platform linux -p linux/x86/exec -e x86/alpha_mixed BufferRegister=ECX -f python</code></p><ul><li><code>-a x86</code>: specifies the architecture as 32-bit x86</li><li><code>--platform linux</code>: specifies OS</li><li><code>-p linux/x86/exec</code>: specifies a preset program (you can use <code>-</code> or <code>stdin</code> for a custom initial shellcode, to be transformed)</li><li><code>-e x86/alpha_mixed</code>: specifies encoding to be alphanumeric</li><li><code>BufferRegister=ECX</code>: specifies an initial register which holds the address of the buffer;
this is needed in order to have some way to refer to the region in which we&#x27;re unpacking our code.
Without this, a short non-alphanumeric preamble is added instead to automatically extract the buffer address</li><li><code>-f python</code>: formats output using python syntax</li></ul><p><code>msfvenom</code> is actually capable of taking an arbitrary assembly snippet and transforming it into an alphanumeric <code>&quot;bootstrapper&quot;</code> which, once injected, unpacks the original shellcode and executes it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="challenges">Challenges<a class="hash-link" href="#challenges" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="06-challenge-nop-sled-redo">06. Challenge: <code>NOP</code>-sled Redo<a class="hash-link" href="#06-challenge-nop-sled-redo" title="Direct link to heading">​</a></h3><p>Redo the last three challenges (9, 10, 11) from <a href="/binary-security/Exploitation Techniques/Shellcodes/Reading">the &quot;Shellcodes&quot; session</a> using NOP-sleds.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="07-challenge-no-nops-allowed">07. Challenge: No <code>NOPs</code> Allowed<a class="hash-link" href="#07-challenge-no-nops-allowed" title="Direct link to heading">​</a></h3><p>This is similar to the previous tasks: you are left to guess a stack address.
However, the <code>\x90</code> byte is filtered from input so you cannot use a NOP sled.
But you should be able to adapt the concept.
Remember the relevant features of the &quot;NOP&quot; instruction!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="08-challenge-multi-line-output">08. Challenge: Multi-line Output<a class="hash-link" href="#08-challenge-multi-line-output" title="Direct link to heading">​</a></h3><p>While perfectly OK with the byte 0, some functions (e.g.
<code>fgets</code>) will stop reading when they encounter a newline character (<code>\n</code>).
Thus, if our input is read by such a function, we need to make sure our shellcode contains no <code>\n</code> bytes.</p><p>For this challenge, the input will be read using the <code>gets</code> function, but you will need to craft a shellcode which prints to <code>stdout</code> the exact string:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">first</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">third</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="09-challenge-execve-blocking-attempt">09: Challenge: <code>execve</code> blocking attempt<a class="hash-link" href="#09-challenge-execve-blocking-attempt" title="Direct link to heading">​</a></h3><p>If shellcodes are such a powerful threat, what if we attempted to block some shellcode-specific characters?
Such as the bytes that encode a <code>syscall</code> function.
Or the slash needed in a path;
maybe it&#x27;s not such a big loss to avoid these in legitimate inputs.</p><p>Can you still get a shell?
For this task, <strong>don&#x27;t use</strong> an existing encoder, but rather apply the encoding principles yourself.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further Reading<a class="hash-link" href="#further-reading" title="Direct link to heading">​</a></h2><p><a href="http://phrack.org/issues/49/14.html" target="_blank" rel="noopener noreferrer">&quot;Smashing The Stack For Fun And Profit&quot;, Aleph One</a> - a legendary attack paper documenting stack buffer overflows and shellcodes.
As it is written in &#x27;96, the examples in it will probably <strong>not</strong> work (either out-of-the-box or with some tweaks).
We recommend perusing it for its historical/cultural significance, but don&#x27;t waste much time on the technical details of the examples.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="input-restrictions">Input restrictions<a class="hash-link" href="#input-restrictions" title="Direct link to heading">​</a></h3><p>The following articles deal with restrictions on the shellcode structure, such as forbidden characters or statistical properties of the input string.
The examples presented will most likely not work as-they-are in a modern environment, so don&#x27;t focus on the technical details, but rather on the methodology presented.</p><p><a href="http://phrack.org/issues/57/15.html" target="_blank" rel="noopener noreferrer"><em>Writing ia32 alphanumeric shellcodes</em>, 2001 - <code>rix</code></a> - probably the first comprehensive presentation of how to automatically convert generic shellcodes to alphanumeric ones.</p><p><a href="http://phrack.org/issues/61/11.html" target="_blank" rel="noopener noreferrer"><em>Building IA32 &#x27;Unicode-Proof&#x27; Shellcodes</em>, 2003 - <code>obscou</code></a> - rather than being concerned with input restrictions, this addresses ulterior transformations on input, namely converting an ASCII string to a UTF-16 one (as mentioned in the article&#x27;s introduction, you could also imagine other possible transformations, such as case normalization).</p><p><a href="http://phrack.org/issues/62/9.html" target="_blank" rel="noopener noreferrer"><em>Writing UTF-8 compatible shellcodes</em>, 2004 - <code>Wana</code></a></p><p><a href="https://www.cs.jhu.edu/~sam/ccs243-mason.pdf" target="_blank" rel="noopener noreferrer"><em>English shellcode</em>, 2009 - Mason, Small, Monrose, MacManus</a> delves into automatically generating shellcode which has the same statistical properties as English text.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/binary-security/Exploitation Techniques/Shellcodes Advanced/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Shellcodes Advanced</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/binary-security/Exploitation Techniques/Return-Oriented Programming/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Return-Oriented Programming</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#tutorials" class="table-of-contents__link toc-highlight">Tutorials</a><ul><li><a href="#01-tutorial-preventing-stack-operations-from-overwriting-the-shellcode" class="table-of-contents__link toc-highlight">01. Tutorial: preventing stack operations from overwriting the shellcode</a></li><li><a href="#02-tutorial-nop-sleds" class="table-of-contents__link toc-highlight">02. Tutorial: NOP sleds</a></li><li><a href="#03-tutorial-null-free-shellcodes" class="table-of-contents__link toc-highlight">03. Tutorial: null-free shellcodes</a></li><li><a href="#04-tutorial-shellcodes-in-pwntools" class="table-of-contents__link toc-highlight">04. Tutorial: shellcodes in pwntools</a></li><li><a href="#05-tutorial-alphanumeric-shellcode" class="table-of-contents__link toc-highlight">05. Tutorial: alphanumeric shellcode</a></li></ul></li><li><a href="#challenges" class="table-of-contents__link toc-highlight">Challenges</a><ul><li><a href="#06-challenge-nop-sled-redo" class="table-of-contents__link toc-highlight">06. Challenge: <code>NOP</code>-sled Redo</a></li><li><a href="#07-challenge-no-nops-allowed" class="table-of-contents__link toc-highlight">07. Challenge: No <code>NOPs</code> Allowed</a></li><li><a href="#08-challenge-multi-line-output" class="table-of-contents__link toc-highlight">08. Challenge: Multi-line Output</a></li><li><a href="#09-challenge-execve-blocking-attempt" class="table-of-contents__link toc-highlight">09: Challenge: <code>execve</code> blocking attempt</a></li></ul></li><li><a href="#further-reading" class="table-of-contents__link toc-highlight">Further Reading</a><ul><li><a href="#input-restrictions" class="table-of-contents__link toc-highlight">Input restrictions</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://security-summer-school.github.io/binary/" target="_blank" rel="noopener noreferrer" class="footer__link-item">site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/SSSUPB/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 SSS Team</div></div></div></footer></div>
<script src="/binary-security/assets/js/runtime~main.74200969.js"></script>
<script src="/binary-security/assets/js/main.d9be8505.js"></script>
</body>
</html>